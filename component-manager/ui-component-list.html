<!--
Â©2015-2016 EdgeVerve Systems Limited (a fully owned Infosys subsidiary), Bangalore, India. All Rights Reserved.
-->
<link rel="import" href="ui-component-creator.html">
<link rel="import" href="../ui-designer/ui-navigation-settings.html">
<dom-module id="ui-component-list">
    <style>
         :host {
            display: block;
            position: relative;
            font-size: 14px;
            height: 40px;
        }

        paper-menu-button {
            box-sizing: border-box;
            height: 40px;
            padding: 0px;
            background: var(--default-primary-color);
            --paper-menu-button-content: {
                border-radius: 0px;
                box-shadow: none;
            }
        }

        paper-menu-button paper-button.dropdown-trigger {
            font-size: 12px;
            border-radius: 0px;
            padding: 12px;
            background: var(--dark-primary-color);
        }

        paper-button.active-page-false {
            background: var(--accent-color) !important;
        }

        paper-menu-button#pageSelectMenu {
            width: 205px;
            box-sizing: border-box;
        }

        .page-listing-component {
            min-width: 300px;
            height: 500px;
            background: var(--default-primary-color);
            color: var(--default-text-color);
        }



        .page-listing .column+.column {
            border-left: 2px solid var(--dark-primary-color);
        }

        .page-list {
            height: 394px;
            overflow: auto;
        }

        .component-row .page-search-list {
            max-height: 152px;
            overflow: auto;
        }

        .component-row .list-header {
            border-bottom: 1px solid var(--light-text-color)
        }

        .list-header {
            height: 48px;
            padding: 0 16px;
            color: var(--light-text-color);
            @apply(--layout-flex);
            @apply(--layout-horizontal);
            @apply(--layout-center);
        }

        .list-item {
            height: 48px;
            padding: 0 16px;
            cursor: pointer;
            position: relative;
            color: var(--default-text-color);
            @apply(--layout-flex);
            @apply(--layout-horizontal);
            @apply(--layout-center);
        }

        .page-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .options {
            position: absolute;
            visibility: hidden;
            right: 0;
            height: 48px;
            padding: 0 16px;
            background: var(--default-primary-color);
            @apply(--layout-horizontal);
            @apply(--layout-center);
        }

        .options iron-icon {
            margin-left: 8px;
        }

        .list-item:hover .options {
            visibility: visible;
        }

        .page-list-panel.delete-true .options {
            pointer-events: none;
            cursor: not-allowed;
        }

        .list-item.iron-selected {
            background: var(--dark-primary-color);
            color: var(--accent-color);
        }

        .list-item.iron-selected .options {
            background: var(--dark-primary-color);
        }

        .page-item,
        .menu-item {
            border-left: 2px solid var(--default-primary-color);
        }

        .list-item:hover {
            box-shadow: 1px 2px 1px rgba(0, 0, 0, 0.20), 1px -2px 1px rgba(0, 0, 0, 0.20);
        }

        .page-item.iron-selected,
        .menu-item.iron-selected {
            border-left: 2px solid var(--accent-color);
        }

        iron-icon {
            --iron-icon-width: 18px;
            --iron-icon-height: 18px;
        }

        iron-icon+span {
            margin-left: 8px;
        }

        span+iron-icon {
            margin-left: 8px;
        }

        .active-page-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 160px;
            font-weight: normal;
        }


        .search-header {
            height: 106px;
            font-size: 14px;
        }

        .page-stats {
            height: 70px;
            padding: 0px 16px;
            opacity: 0.6;
        }

        #search {
            height: 36px;
            padding: 0px 16px;
            box-sizing: border-box;
            background: var(--light-primary-color);
        }

        #search #input {
            border: none;
            outline: none;
            width: 100%;
            background: inherit;
            padding: 5px 8px;
            margin: 0px;
            height: 36px;
            box-sizing: border-box;
            color: var(--default-text-color);
        }

        #input::-webkit-input-placeholder {
            color: rgba(255, 255, 255, 0.54);
        }

        #input::-moz-placeholder {
            color: rgba(255, 255, 255, 0.54);
        }

        #input:-ms-input-placeholder {
            color: rgba(255, 255, 255, 0.54);
        }

        .empty-state {
            padding: 16px;
            text-align: center;
            font-family: 'Roboto-Light';
        }


        .active-page-name label {
            font-family: Roboto-Regular;
            font-size: 12px;
            color: #ffffff;
            letter-spacing: 0;
            line-height: 18px;
        }

        .active-page-name iron-icon {
            --iron-icon-width: 16px;
            --iron-icon-height: 16px;
            margin-right: 6px;
            opacity: 0.54;
        }

        #pageSelectMenu .dropdown-content {
            margin-bottom: 12px;
            position: relative;
        }

        #pageSelectMenu .dropdown-content:after {
            content: "";
            position: absolute;
            left: 12px;
            border-style: solid;
            border-width: 10px 10px 0 10px;
            border-color: var(--default-primary-color) transparent transparent transparent;
        }



        #pageSelectMenu .dropdown-content.create-component-1:after {
            border-color: var(--dark-primary-color) transparent transparent transparent;
        }

        .mini-heading {
            display: block;
            padding-top: 12px;
            letter-spacing: 0.7px;
        }

        .helper-text {
            font-size: 12px;
            font-family: 'Roboto-Light';
        }

        .scope-text {
            font-size: 11px;
        }

        #add-component-panel {
            color: var(--accent-color);
        }
    </style>
    <template>
        <div class="layout horizontal center">
            <paper-menu-button no-animations no-overlap vertical-align="bottom" ignore-select id="pageSelectMenu" opened="{{opened}}">
                <paper-button class$="dropdown-trigger active-page-{{hasActivePage}}" noink>
                    <span class="flex active-page-name" hidden$="{{hasActivePage}}">Create/Manage Components</span>
                    <span class="flex active-page-name" hidden$="{{!hasActivePage}}">
						<iron-icon icon="polymer"></iron-icon>
						<label>[[activePage.name]]</label>
					</span>
                    <iron-icon icon="icons:arrow-drop-down"></iron-icon>
                </paper-button>
                <div class$="dropdown-content create-component-{{step}}">
                    <div class="page-listing-component">
                        <iron-pages selected="{{step}}">
                            <div class="page-listing">
                                <div class="search-header">
                                    <div class="page-stats">
                                        <label class="mini-heading">Manage Form Components</label>
                                        <div class="layout horizontal center justified">
                                            <span class="helper-text">{{polymerCount}} Components</span>
                                            <iron-icon icon="refresh" on-tap="fetchInitialData"></iron-icon>
                                            <paper-button id="add-component-panel" on-tap="showPageCreation">
                                                <iron-icon icon="oe-designer-icons:add-page"></iron-icon><span>Add Component</span>
                                            </paper-button>
                                        </div>
                                    </div>
                                    <div id="search" class="layout center horizontal">
                                        <iron-icon icon="search"></iron-icon>
                                        <input type="search" placeholder="Search Components..." id="input" bind-value="{{searchKey}}" autocomplete="off" is="iron-input">
                                    </div>
                                </div>
                                <div class="page-list">
                                    <template is="dom-repeat" items="{{getComponents(componentList.*)}}" as="page" filter="{{_filter(searchKey)}}">
                                        <div id="id_{{page.id}}" name$="[[page.name]]" class$="page-item list-item layout horizontal center justified [[isActivePage(activePage,page)]]"
                                            on-tap="_editPage">
                                            <iron-icon icon="polymer"></iron-icon>
                                            <span class="flex page-name">[[page.name]]</span>
                                            <template is="dom-if" if="{{page.scope}}"><span class="scope-text">{ ... }</span></template>
                                            <div class="options">
                                                <iron-icon icon="file-download" on-tap="_downloadComponent"></iron-icon>
                                                <iron-icon icon="delete" on-tap="_deleteComponent"></iron-icon>
                                            </div>
                                            <template is="dom-if" if="{{page.scope}}">
                                                <paper-tooltip for="id_{{page.id}}">
                                                    <pre>{{formatJSON(page.scope)}}</pre>
                                                </paper-tooltip>
                                            </template>
                                        </div>
                                    </template>
                                    <template is="dom-if" if="{{polymerListEmpty}}">
                                        <div class="empty-state">No Components created yet</div>
                                    </template>
                                </div>
                            </div>
                            <ui-component-creator id="uiCreateComponent" template-list="[[templateList]]" component-list="[[componentList]]" on-hide-create-component="showPageListing"></ui-component-creator>
                        </iron-pages>
                    </div>
                </div>
            </paper-menu-button>
            <paper-menu-button id="pageSettingsIcon" no-animations no-overlap vertical-align="bottom" ignore-select class="page-settings"
                hidden$="{{!hasActivePage}}">
                <paper-icon-button class="dropdown-trigger" noink icon="settings">
                </paper-icon-button>
                <div class="dropdown-content">
                    <ui-navigation-settings id="pageSettingsPanel" active-page="{{activePage}}" on-close-panel="closePageSettings"></ui-navigation-settings>
                </div>
            </paper-menu-button>
        </div>
    </template>
    <script>
        Polymer({
            is: 'ui-component-list',
            properties: {
                componentList: {
                    type: Array,
                    value: []
                },
                templateList: {
                    type: Array,
                    value: [],
                    notify: true
                },
                selected: {
                    type: Number,
                    value: 0
                },
                activePage: {
                    type: Object,
                    notify: true,
                    value: {},
                    observer: 'isActivePageExists'
                },
                hasActivePage: {
                    type: Boolean,
                    value: false,
                    notify: true,
                    reflectToAtrribute: true
                },
                polymerCount: {
                    type: Number,
                    value: 0
                },
                staticCount: {
                    type: Number,
                    value: 0
                },
                opened: {
                    observer: '_openedObserver'
                },
                searchKey: {
                    type: String,
                    value: ''
                }
            },
            behaviors: [CommonBehavior.EVAjaxBehavior, CommonBehavior.HTMLHelper],
            listeners: {
                'component-created': 'newPageCreated',
                'page-deleted': 'deletePage'
            },
            closePageSettings: function (event) {
                if (event) {
                    event.stopPropagation();
                }
                this.$.pageSettingsIcon.close();
            },
            formatJSON: function (value) {
                return JSON.stringify(value, null, 2);
            },
            _filter: function (val) {
                return function (model) {
                    if (!val) {
                        return true;
                    }
                    if (!model) {
                        return false;
                    }
                    return (model.name.toLowerCase().indexOf(val.toLowerCase()) != -1);
                }
            },
            showPageCreation: function () {
                var elem = this.$.uiCreateComponent;
                elem.reset();
                elem.set('componentType', this.selected);
                this.step = 1;
            },
            _openedObserver: function () {
                if (this.opened) {
                    this.showPageListing();
                }
            },
            showPageListing: function () {
                this.step = 0;
                this.set('searchKey', '');
            },
            attached: function () {
                this.step = 0;
                this.fetchInitialData();
            },
            fetchInitialData: function () {
                var self = this;
                async.parallel({
                    templateList: function (callback) {
                        self.makeAjaxCall('/designer/templates', 'get', null, null, null,
                            function (
                                err, res) {
                                if (err) {
                                    self.fire('oe-show-error', 'Error fetching Templates');
                                    callback(err, null)
                                } else {
                                    callback(null, res)
                                }
                            })
                    },
                    uiComponents: function (callback) {
                        self.makeAjaxCall(OEUtils._getRestApiUrl('/UIComponents'), 'get', null, null, null,
                            function (err,
                                res) {
                                if (err) {
                                    self.fire('oe-show-error',
                                        'Error fetching UIComponents');
                                    callback(err, null)
                                } else {
                                    callback(null, res)
                                }
                            })
                    }
                }, function (err, results) {
                    if (!err) {
                        self.set('templateList', results.templateList || []);
                        self.set('componentList', results.uiComponents || []);
                    }
                });
            },
            isActivePageExists: function () {
                if (this.activePage && Object.keys(this.activePage).length != 0) {
                    this.set('hasActivePage', true);
                    return true;
                } else {
                    this.set('hasActivePage', false);
                    return false;
                }
            },
            isActivePage: function (activePage, currPage) {
                return (activePage && (activePage.id == currPage.id)) ? 'iron-selected' : '';
            },
            getComponents: function () {
                /* var list = this.componentList.filter(function (obj) {
                    return (obj.modelName && obj.templateName)
                }) */
                // var list = this.componentList;
                this.set('polymerCount', this.componentList.length);
                this.set('polymerListEmpty', this.componentList.length ? false : true)
                return this.componentList;
            },
            deletePage: function (event) {
                this.set('deleteFlag', false);
                var pageData = event.detail;
                if (this.activePage.id == pageData.id) {
                    this.fire('clear-workspace');
                    this.set('activePage', {});
                }
                var pageIndex = this.componentList.findIndex(function (p) {
                    return p.id == pageData.id;
                })
                
                this.splice('componentList', pageIndex, 1);
                this.fire('oe-show-success', pageData.name + ' successfully deleted');
            },
            newPageCreated: function (e) {
                this.showPageListing();
                var pageData = e.detail;
                pageData.isPolymerElement = true
                this.push('componentList', pageData);
                this._handleEditLaunch(pageData);
            },
            updateComponent: function (comp) {
                var apiurl = OEUtils._getRestApiUrl('/UIComponents/');
                var self = this;
                this.makeAjaxCall(apiurl, 'put', comp, null, null, function (err, res) {
                    if (!err) {
                        var index = self.componentList.findIndex(function (c) {
                            return c.id === res.id;
                        });
                        self.set('componentList.' + index, res);
                        self._handleEditLaunch(res);
                        self.fire('oe-show-success', 'Element successfully updated');
                    } else {
                        self.resolveError(err);
                    }
                })
            },
            _downloadComponent: function (event) {
                var self = this;
                var pageData = event.model.page;
                self.makeAjaxCall(OEUtils._getRestApiUrl('/UIComponents/component/') + pageData.name, 'get', null, null, null, {
                    handleAs: 'text'
                }, function (err, res) {
                    if (err) {
                        self.fire('oe-show-error', 'Error fetching component');
                    } else {
                        self.downloadToFile(pageData.name + '.html', 'text/html', res);
                    }
                });
            },
            _deleteComponent: function (event) {
                event.stopPropagation();
                var pageData = event.model.page;
                var self = this;
                var elemDeleteUrl = OEUtils._getRestApiUrl('/UIComponents/') + pageData.id;
                self.makeAjaxCall(elemDeleteUrl, 'delete', {}, null, null, function (err) {
                    if (!err) {
                        self.fire('page-deleted', pageData)
                    } else {
                        self.resolveError(err);
                    }
                })
            },
            _handleEditLaunch: function (pageData) {
                var page = JSON.parse(JSON.stringify(pageData));
                this.$.pageSettingsPanel.getRouteDetails(page,function(resp){
                    page.routeData = resp;
                    this.set('activePage', page);
                    this.fire('page-selected', pageData);
                    this.$.pageSelectMenu.close();
                }.bind(this))
            },
            _editPage: function (e) {
                this._handleEditLaunch(e.model.page);
            }
        })
    </script>
</dom-module>