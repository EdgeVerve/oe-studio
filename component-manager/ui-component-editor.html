<link rel="import" href="../styles/oe-studio-styles.html">
<dom-module id="ui-component-editor">
    <template>
        <style include="oe-studio-styles">
             :host {
                position: relative;
                display: block;
                box-sizing: border-box;
                padding: 16px;
                background: var(--default-primary-color);
                color: #fff;
                box-shadow: 0px -2px 1px rgba(0, 0, 0, 0.61) inset;
                height: 100%;
                width:330px;
            }

            .more-props {
                padding: 12px 0px;
            }

            .component-name {
                margin-bottom: 16px;
                display: inline-block;
            }

            #field-delete-icon {
                float: right;
            }

            .prop-list {
                overflow: auto;
                border-top: 2px solid var(--dark-primary-color);
                border-bottom: 2px solid var(--dark-primary-color);
                max-height: 220px;
                padding: 8px 0px;
            }

            paper-toggle-button {
                --paper-toggle-button-label-color: #ffffff;
            }

            .helper-text {
                font-size: 12px;
                font-style: italic;
                opacity: 0.54;
                margin-top: 8px;
            }

            .prop {
                font-size: 12px;
                padding: 4px 8px;
                margin: 6px 0px;
                background: var(--dark-primary-color);
                border-radius: 4px;
                max-width: 200px;
            }

            .prop-item {
                --paper-checkbox-unchecked-color: rgba(255, 255, 255, 0.6);
                --paper-checkbox-checked-color: #ffffff;
                --paper-checkbox-checkmark-color: #000000;
                --paper-checkbox-label-color: #ffffff;
                --paper-checkbox-label: {
                    max-width: 150px;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    overflow: hidden;
                }
            }

            .prop iron-icon {
                width: 18px;
                height: 18px;
            }

            .field-form {
                height: calc(100vh - 100px);
                padding-bottom: 36px;
                position: relative;
            }

            .field-form iron-icon {
                --iron-icon-width: 20px;
                --iron-icon-height: 20px;
            }

            .dynamic-prop-handler {
                margin: 4px 0px;
                height: 54px;
            }

            .field-form .prop-label {
                font-size: 12px;
                min-width: 80px;
            }

            .field-form paper-toggle-button {
                transform: scale(0.8);
            }

            .prop-panel-header {
                height: 30px;
                font-size: 12px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            }

            .props-list .prop-item {
                font-size: 14px;
                height: 30px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .prop-item label {
                flex: 4;
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            .prop-item .prop-option {
                flex: 1;
            }

            .prop-item .prop-option iron-icon {
                --iron-icon-width: 16px;
                --iron-icon-height: 16px;
            }

            .prop-container {
                height: 40px;
            }

            .prop-container .dynamic {
                width: 60px;
                font-size: 12px;
            }

            .prop-container.boolean-prop-header {
                border-top: 1px solid rgba(255, 255, 255, 0.4);
                border-bottom: 1px solid rgba(255, 255, 255, 0.4);
                height: 30px;
            }

            .add-props-panel {
                padding: 4px;
            }

            .add-props-panel label {
                margin: 4px 0px;
                font-size: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .button-panel {
                position: absolute;
                bottom: 0px;
                width: 100%;
            }

            .field-form .props-list {
                max-height: 160px;
                overflow: auto;
            }

            .field-form .add-props-panel {
                max-height: 180px;
                overflow: auto;
            }

            paper-button {
                font-size: 12px;
                height: 30px;
                background: var(--accent-color);
            }

            .add-field-label {
                font-size: 12px;
                margin: 8px 0px;
                display: block;
            }

            .prop-list .prop paper-checkbox[status="status-"] {
                --paper-checkbox-unchecked-background-color: grey;
            }

            .prop-list .prop paper-checkbox[status="status-false"] {
                --paper-checkbox-unchecked-background-color: red;
            }
            #addToUI{
                margin: 0px 8px;
            }
        </style>
        <div class="component-container">
            <iron-pages selected="[[panelSelected]]">
                <div class="component-form">
                    <label class="component-name">Component Name : [[component.name]]</label>
                    <oe-input label="Rest URL" value="{{component.restUrl}}"></oe-input>
                    <oe-combo label="Template Name" listdata="[[templateList]]" value="{{component.templateName}}" valueproperty="file" displayproperty="file"></oe-combo>
                    <oe-combo id="modelName" show-refresh value="{{component.modelName}}" label="Models" displayproperty="name" valueproperty="name"
                        listurl="/api/ModelDefinitions?filter[fields][name]=true"></oe-combo>
                    <div>
                        <div class="more-props" hidden$="[[!component.modelName]]">
                            <paper-toggle-button checked="{{component.autoInjectFields}}">Auto Inject Fields</paper-toggle-button>
                            <div class="helper-text">Properties updated in the model will be injected in the form automatically</div>
                        </div>
                        <div class="prop-list">
                            <template is="dom-repeat" items="[[modelProperties]]">
                                <div class="prop layout horizontal justified center" field$="[[item.name]]">
                                    <paper-checkbox on-change="_refineFieldsEntry" status$="status-[[item.applied]]" checked="{{item.applied}}" class="prop-item">[[item.name]]</paper-checkbox>
                                    <div>
                                        <iron-icon icon="icons:delete" on-tap="_UnsetField"></iron-icon>
                                        <iron-icon icon="icons:settings" on-tap="_openFieldSetting"></iron-icon>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="layout horizontal justified end add-field-panel">
                            <div>
                                <label class="add-field-label">Field Id</label>
                                <oe-input no-label-float label="field Id" value="{{newFieldId}}"></oe-input>
                            </div>
                            <paper-button on-tap="_addNewField" id="addToUI">
                                <iron-icon icon="add"></iron-icon>
                                <label>screen</label>
                            </paper-button>
                            <paper-button on-tap="_addModelField">
                                <iron-icon icon="add"></iron-icon>
                                <label>model</label>
                            </paper-button>
                        </div>
                    </div>
                </div>
                <div class="field-form">
                    <label class="component-name">Field Id : [[fieldMeta.fieldId]]</label>
                    <iron-icon icon="delete" id="field-delete-icon" on-tap="_removeField"></iron-icon>
                    <div class="layout horizontal center justified prop-container">
                        <label class="prop-label">Label</label>
                        <oe-input class="flex" no-label-float label="Label" value="{{fieldMeta.label}}"></oe-input>
                    </div>
                    <div class="layout horizontal center justified prop-container">
                        <label class="prop-label">Class</label>
                        <oe-input class="flex" no-label-float label="Class" value="{{fieldMeta.class}}"></oe-input>
                    </div>
                    <div class="layout horizontal center justified prop-container">
                        <label class="prop-label">Container</label>
                        <oe-combo class="flex" no-label-float label="Container" listdata="[[containers]]" value="{{fieldMeta.container}}"></oe-combo>
                    </div>
                    <div class="layout horizontal center justified prop-container">
                        <label class="prop-label">UIType</label>
                        <oe-combo class="flex" no-label-float label="UIType" listdata="[[uiTypesList]]" value="{{fieldMeta.uitype}}" allow-free-text></oe-combo>
                    </div>
                    <div class="prop-container layout horizontal center justified boolean-prop-header">
                        <label class="prop-label">Key</label>
                        <label class="dynamic">Dynamic</label>
                        <label class="prop-input flex prop-label">Value</label>
                    </div>
                    <div class="prop-container layout horizontal center justified">
                        <label class="prop-label">Required</label>
                        <paper-toggle-button class="dynamic" checked="{{fieldMeta.required.dynamic}}"></paper-toggle-button>
                        <div class="prop-input flex">
                            <template is="dom-if" if="{{fieldMeta.required.dynamic}}">
                                <oe-input no-label-float label="required" value="{{fieldMeta.required.dynamicValue}}"></oe-input>
                            </template>
                            <template is="dom-if" if="{{!fieldMeta.required.dynamic}}">
                                <paper-checkbox checked="{{fieldMeta.required.value}}"></paper-checkbox>
                            </template>
                        </div>
                    </div>
                    <div class="prop-container layout horizontal center justified">
                        <label class="prop-label">Disabled</label>
                        <paper-toggle-button class="dynamic" checked="{{fieldMeta.disabled.dynamic}}"></paper-toggle-button>
                        <div class="prop-input flex">
                            <template is="dom-if" if="{{fieldMeta.disabled.dynamic}}">
                                <oe-input no-label-float label="disabled" value="{{fieldMeta.disabled.dynamicValue}}"></oe-input>
                            </template>
                            <template is="dom-if" if="{{!fieldMeta.disabled.dynamic}}">
                                <paper-checkbox checked="{{fieldMeta.disabled.value}}"></paper-checkbox>
                            </template>
                        </div>
                    </div>
                    <div class="prop-container layout horizontal center justified">
                        <label class="prop-label">Hidden</label>
                        <paper-toggle-button class="dynamic" checked="{{fieldMeta.hidden.dynamic}}"></paper-toggle-button>
                        <div class="prop-input flex">
                            <template is="dom-if" if="{{fieldMeta.hidden.dynamic}}">
                                <oe-input no-label-float label="hidden" value="{{fieldMeta.hidden.dynamicValue}}"></oe-input>
                            </template>
                            <template is="dom-if" if="{{!fieldMeta.hidden.dynamic}}">
                                <paper-checkbox checked="{{fieldMeta.hidden.value}}"></paper-checkbox>
                            </template>
                        </div>
                    </div>
                    <div class="attributes-list">
                        <div class="prop-panel-header layout horizontal justified center">
                            <iron-icon on-tap="_cancelAddPropForm" icon="arrow-back" hidden="[[!showAddProp]]"></iron-icon>
                            <label hidden="[[!showAddProp]]">Add Attributes</label>
                            <label hidden="[[showAddProp]]">Additional Attributes</label>
                            <iron-icon on-tap="_showAddPropForm" icon="add" hidden="[[showAddProp]]"></iron-icon>
                        </div>
                        <iron-pages selected="[[showAddProp]]" attrib-for-selected="add-panel">
                            <div class="props-list" add-panel=false>
                                <div class="prop-item layout horizontal center justified">
                                    <label class="key-disp">Key</label>
                                    <label class="value-disp">Value</label>
                                    <div class="prop-option"></div>
                                </div>
                                <template is="dom-repeat" items="{{fieldMeta._props}}">
                                    <div class="prop-item layout horizontal center justified">
                                        <label class="key-disp">[[item.key]]</label>
                                        <label class="value-disp">[[_displayPropValue(item)]]</label>
                                        <div class="prop-option layout horizontal center justified">
                                            <iron-icon icon="create" on-tap="_editProp"></iron-icon>
                                            <iron-icon icon="delete" on-tap="_deleteProp"></iron-icon>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div class="add-props-panel" add-panel=true>
                                <div class="layout horizontal center justified">
                                    <label class="prop-label">Key</label>
                                    <oe-input class="flex" no-label-float value="{{newProp.key}}" label="Key"></oe-input>
                                </div>
                                <label>Value <paper-toggle-button checked="{{isPropString}}">(String Value)</paper-toggle-button></label>
                                <template is="dom-if" if="[[isPropString]]" restamp>
                                    <oe-input no-label-float value="{{newProp.value}}" label="Value"></oe-input>
                                </template>
                                <template is="dom-if" if="[[!isPropString]]" restamp>
                                    <oe-json-input no-label-float value="{{newProp.value}}" label="Value"></oe-json-input>
                                </template>
                                <paper-button on-tap="_addNewProp">ADD</paper-button>
                            </div>
                        </iron-pages>
                    </div>
                    <div class="button-panel layout horizontal justified" hidden="[[showAddProp]]">
                        <paper-button on-tap="_applyFieldMeta">Apply</paper-button>
                        <paper-button on-tap="_closeFieldMeta">Cancel</paper-button>
                    </div>
                </div>
            </iron-pages>
        </div>
    </template>
    <script>
        Polymer({
            is: "ui-component-editor",
            properties: {
                metaData: {
                    type: Object,
                    observer: "_metaDataChanged"
                },
                component: {
                    type: Object
                },
                containers: {
                    type: Array
                }
            },
            behaviors: [CommonBehavior.EVAjaxBehavior],
            observers: ['_componentDataChanged(component.*)'],
            attached: function () {
                this.set('panelSelected', 0);
                var list = [];
                Object.keys(OEUtils.TypeMappings).forEach(function (k) {
                    var v = OEUtils.TypeMappings[k];
                    if (list.indexOf(v.uiType) === -1) {
                        list.push(v.uiType)
                    }
                })
                this.set('uiTypesList', list);
            },
            _metaDataChanged: function (nval, oval) {
                if (oval !== nval && nval) {
                    if (!this.component) {
                        this.set('isPendingGeneration', true);
                        return;
                    }
                    this.generateFieldsArr(this.metaData.metadata.models)
                }
            },
            generateFieldsArr: function (resp) {
                var properties = [];
                this.set('modelProperties', []);
                Polymer.dom.flush();
                this.component.fields.forEach(function (s) {
                    var fieldMeta = (typeof s === "string") ? {
                        'fieldId': s
                    } : s;
                    var obj = {
                        'index': -1,
                        'name': fieldMeta.fieldId,
                        'fieldMeta': fieldMeta,
                        'applied': true
                    }
                    properties.push(obj);
                });

                this.component.excludeFields.forEach(function (s) {
                    var fieldMeta = (typeof s === "string") ? {
                        'fieldId': s
                    } : s;
                    var obj = {
                        'index': -1,
                        'name': s,
                        'fieldMeta': {
                            'fieldId': s
                        },
                        'applied': false
                    }
                    properties.push(obj);
                })
                if(resp && resp[this.component.modelName]){
                    var modelData = resp[this.component.modelName];
                    Object.keys(modelData.properties).filter(function (prop) {
                        return !(prop[0] == '_' || prop == 'id' || prop == 'scope')
                    }).forEach(function (prop, idx) {
                        var modelprop = {
                            'index': idx,
                            'name': prop,
                            'fieldMeta': {
                                'fieldId': prop
                            },
                            'applied': undefined //this.component.autoInjectFields
                        }
                        var isExitingField = properties.find(function (p) {
                            return p.name === modelprop.name
                        })
                        if (isExitingField) {
                            isExitingField.index = modelprop.index;
                        } else {
                            properties.push(modelprop);
                        }
                    }.bind(this));
                }
                properties = _.uniqBy(properties, 'name');
                this.set('modelProperties', properties.sort(function (a, b) {
                    return (a.applied === b.applied) ? 0 : (b.applied ? 1 : -1)
                }));
                this.configureSortable();
            },
            _componentDataChanged: function (change) {
                if (change.path === "component") {
                    if (this.isPendingGeneration) {
                        this.set('isPendingGeneration', false);
                        this.generateFieldsArr(this.metaData.metadata.models)
                    }
                    return;
                }
                if (change.path === "component.modelName") {
                    //this.component.fields = []
                    this.component.excludeFields = [];
                }
                this.fire('component-updated', this.component);
            },
            configureSortable: function () {
                Polymer.dom.flush();
                var containers = this.querySelectorAll('.prop-list');
                [].forEach.call(containers, function attachSortable(el) {
                    Sortable.create(el, {
                        animation: 150,
                        draggable: '.prop',
                        onUpdate: function (e) {
                            var movedField = this.modelProperties.splice(e.oldIndex, 1)[
                                0];
                            this.modelProperties.splice(e.newIndex, 0, movedField);
                            this._refineFieldsEntry();
                        }.bind(this)
                    });
                }.bind(this))
            },
            _refineFieldsEntry: function () {
                var fields = [];

                var includedFields = this.modelProperties.filter(function (prop) {
                    return JSON.stringify(prop.applied) === "true";
                });

                /* 
                    Commenting out fields array trimming logic
                    var diffIndex = 0;
                    for (var i = includedFields.length - 1; i > 0; i--) {
                        if (includedFields[i]["index"] < includedFields[i - 1]["index"]) {
                            diffIndex = i;
                            break;
                        }
                    }
                    // Gives the new order of the fields
                    var modified = includedFields.slice(0, diffIndex);

                    this.component.fields.forEach(function (f) {
                        var idx = modified.findIndex(function (k) {
                            return k.fieldMeta && k.fieldMeta.fieldId == f.fieldId
                        });
                        if (idx === -1) {
                            modified.push({
                                fieldMeta: f
                            })
                        } else {
                            modified[idx]["fieldMeta"] = f;
                        }
                    })
                    this.component.fields = modified.map(function (f) {
                        return f.fieldMeta
                    });
                */

                this.component.excludeFields = this.modelProperties.filter(function (prop) {
                    return JSON.stringify(prop.applied) === "false";
                }).map(function (prop) {
                    return prop.name;
                });
                includedFields.forEach(function (f) {
                    var prevField = this.component.fields.find(function (field) {
                        return f.name === field.fieldId
                    })
                    fields.push(prevField || f.fieldMeta);
                }.bind(this))

                this.component.fields = fields;

                this.component.fields = this.component.fields.filter(function (f) {
                    return (this.component.excludeFields.indexOf(f.fieldId) === -1)
                }.bind(this));

                this.fire('component-updated', this.component);
            },
            showFieldEditor: function (fieldId) {
                if (fieldId && fieldId.length > 0) {
                    var fmeta = {
                        "fieldId": fieldId
                    };
                    this.set('fieldMeta', {});
                    var field = this.modelProperties.find(function (prop) {
                        return prop.name === fieldId;
                    });
                    this.set('isModelField', !!(field && field.index > -1));
                    var boolKeys = ["required", "disabled", "hidden"];
                    var handleKeys = ["label", "container", "class", "uitype", "fieldId"]
                    var componentField = this.component.fields.find(function (prop) {
                        return prop.fieldId === fieldId;
                    });
                    var additionalProps = [];
                    if (componentField) {
                        componentField = JSON.parse(JSON.stringify(componentField));
                        Object.keys(componentField).forEach(function (k) {
                            var v = componentField[k];
                            if (boolKeys.indexOf(k) !== -1) {
                                fmeta[k] = {
                                    dynamic: (typeof v !== "boolean")
                                }
                                if (fmeta[k]["dynamic"]) {
                                    fmeta[k]["dynamicValue"] = v;
                                } else {
                                    fmeta[k]["value"] = v;
                                }
                            } else if (handleKeys.indexOf(k) !== -1) {
                                fmeta[k] = v;
                            } else {
                                additionalProps.push({
                                    key: k,
                                    value: v
                                });
                            }
                        });
                    }
                    fmeta.required = fmeta.required || {}
                    fmeta.disabled = fmeta.disabled || {}
                    fmeta.hidden = fmeta.hidden || {}
                    fmeta._props = additionalProps;
                    this.set('fieldMeta', fmeta);
                    this.set('showAddProp', false);
                    this.set('panelSelected', 1);
                } else {
                    this.set('panelSelected', 0);
                }
            },
            _showAddPropForm: function () {
                this.set('showAddProp', true);
                this.set('newProp', {})
            },
            _cancelAddPropForm: function () {
                this.set('showAddProp', false);
                this.set('isPropString', false);
                this.set('newProp', {})
            },
            _addNewProp: function () {
                var payload = JSON.parse(JSON.stringify(this.newProp));
                if (payload.key && payload.value) {
                    var predefKeys = ["required", "disabled", "hidden", "label", "container", "class",
                        "uitype", "fieldId"
                    ];
                    if (predefKeys.indexOf(payload.key) !== -1) {
                        this.fire('oe-show-error', 'invalid property type');
                        return;
                    }
                    var idx = this.fieldMeta._props.findIndex(function (s) {
                        return s.key === payload.key
                    }.bind(this));

                    if (idx === -1) {
                        this.push('fieldMeta._props', payload);
                    } else {
                        this.set('fieldMeta._props.' + idx, payload);
                    }
                    this._cancelAddPropForm();
                }
            },
            _displayPropValue: function (prop) {
                return (typeof prop.value === "object") ? JSON.stringify(prop.value) : prop.value;
            },
            _editProp: function (e) {
                var prop = e.model.item;
                this.set('showAddProp', true);
                this.set('isPropString', typeof prop.value === "string");
                Polymer.dom.flush();
                this.set('newProp', JSON.parse(JSON.stringify(prop)));
            },
            _deleteProp: function (e) {
                this.splice('fieldMeta._props', e.model.index, 1);
            },
            _openFieldSetting: function (e) {
                var field = e.model.item;
                this.showFieldEditor(field.name);
            },
            _applyFieldMeta: function () {
                var payloadFmeta = {
                    fieldId: this.fieldMeta.fieldId,
                    label: this.fieldMeta.label,
                    required: this.fieldMeta.required.dynamic ? this.fieldMeta.required.dynamicValue : this
                        .fieldMeta.required.value,
                    hidden: this.fieldMeta.hidden.dynamic ? this.fieldMeta.hidden.dynamicValue : this.fieldMeta
                        .hidden.value,
                    disabled: this.fieldMeta.disabled.dynamic ? this.fieldMeta.disabled.dynamicValue : this
                        .fieldMeta.disabled.value,
                    class: this.fieldMeta.class,
                    container: this.fieldMeta.container,
                    uitype: this.fieldMeta.uitype
                };
                this.fieldMeta._props.forEach(function (p) {
                    payloadFmeta[p.key] = p.value
                });
                Object.keys(payloadFmeta).forEach(function (k) {
                    if (payloadFmeta[k] === undefined) {
                        delete payloadFmeta[k]
                    }
                });
                var prevFieldIndex = this.component.fields.findIndex(function (f) {
                    return f.fieldId === this.fieldMeta.fieldId
                }.bind(this));
                if (prevFieldIndex === -1) {
                    this.component.fields.push(payloadFmeta);
                } else {
                    this.component.fields.splice(prevFieldIndex, 1, payloadFmeta);
                }
                var modelPropIndex = this.modelProperties.findIndex(function (f) {
                    return f.name === this.fieldMeta.fieldId
                }.bind(this));
                if (modelPropIndex === -1) {
                    this.modelProperties.push({
                        name: this.fieldMeta.fieldId,
                        applied: true
                    })
                }

                this._refineFieldsEntry();
                this._closeFieldMeta();
            },
            _closeFieldMeta: function () {
                this.set('panelSelected', 0);
            },
            _addNewField: function () {
                this.showFieldEditor(this.newFieldId);
                this.splice('modelProperties', 0, 0, {
                    name: this.newFieldId,
                    applied: true
                });
                this.set('newFieldId', "");
            },
            _addModelField:function(){
                var isExist = this.modelProperties.find(function(s){
                    return s.name === this.newFieldId;
                }.bind(this));
                if(isExist){
                    this.fire('oe-show-error','Model Property already exists');
                    return;
                }
                this.fire('add-field-to-model',{
                    'model':this.component.modelName,
                    'fieldId':this.newFieldId
                });
                this._addNewField();
            },
            _removeField: function () {
                var index = this.modelProperties.findIndex(function (m) {
                    return m.name === this.fieldMeta.fieldId
                }.bind(this))
                if (index > -1) {
                    if (this.isModelField) {
                        this.set('modelProperties.' + index + '.applied', undefined);
                    } else {
                        this.splice('modelProperties', index, 1)
                    }
                }
                this.set('panelSelected', 0);
                this._refineFieldsEntry();
            },
            _UnsetField: function (e) {
                var fieldIndex = e.model.index;
                this.set('modelProperties.' + fieldIndex + '.applied', undefined);
                this.set('panelSelected', 0);
                this._refineFieldsEntry();
            }
        })
    </script>
</dom-module>