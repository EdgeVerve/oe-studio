<!--
Â©2015-2016 EdgeVerve Systems Limited (a fully owned Infosys subsidiary), Bangalore, India. All Rights Reserved.
-->
<dom-module id="ui-component-detail">
    <template>
        <style>
             :host {
                position: relative;
                display: block;
                box-sizing: border-box;
                background: grey;
                padding: 8px;
                --hover-color: blue;
                --selection-color: orange;
            }

            .component-container {
                height: 100%;
                box-sizing: border-box;
                padding: 16px;
                background: #FFF;
                overflow: auto;
            }

            #previewBox [field-id] {
                position: relative;
            }

            #previewBox [field-id]:hover {
                outline: 2px solid var(--hover-color);
                outline-offset: -2px;
                position: relative;
            }

            .current-selection {
                outline: 2px solid var(--selection-color);
                outline-offset: -2px;
            }

            #previewBox [field-id]:hover:before,
            .current-selection:before {
                content: attr(field-id);
                position: absolute;
                padding: 4px;
                font-size: 10px;
                color: #FFF;
                top: 0px;
                left: 0px;
            }

            #previewBox [field-id]:hover:before {
                background: var(--hover-color);
            }

            .current-selection:before {
                background: var(--selection-color);
            }
        </style>
        <div class="component-container" on-click="_handleClick">
            <div id="previewBox">

            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: "ui-component-detail",
            properties: {
                component: {
                    type: Object,
                    observer: '_componentChanged'
                },
                templateContainers: {
                    type: Array,
                    value: function () {
                        return []
                    },
                    notify:true
                },
                metaData: {
                    type: Object,
                    notify: true
                }
            },
            observers: ['_elementChanged(element.*)'],
            behaviors: [CommonBehavior.EVAjaxBehavior, DesignerBehavior.HTMLBehavior],
            _componentChanged: function (nval, oval) {
                if (oval !== nval && nval) {
                    this.simulateComponent();
                }
            },
            simulateComponent: function () {
                this.makeXhrCall('/api/UIComponents/simulate', 'post', this.component, null, function (err,
                    res) {
                    if (err) {
                        this.resolveError(err);
                    } else {
                        var component = this.createNodeFromStr(res);
                        var scrTag = (component.nodeName.toLowerCase() == 'script') ? component :
                            component.querySelector('script');
                        if (scrTag) {
                            var target = 'OEUtils.metadataCache["' + this.component.name + '"]';
                            var text = scrTag.textContent.split(target)[1];
                            text = 'window.OEUtils.tempMeta ' + text;
                            this.customEval(text);
                            if (scrTag.parentElement) {
                                scrTag.parentElement.removeChild(scrTag);
                            }
                        }
                        this.set('metaData', window.OEUtils.tempMeta);
                        window.OEUtils.tempMeta = null;
                        this.set('element', component.querySelector('dom-module[id="' + this.component
                            .name + '"]'))
                    }
                }.bind(this))
            },
            customEval: function (str) {
                var script = document.createElement('script');
                script.type = 'text/javascript';
                //Clear all content before Polymer invocation.
                str = str.replace(/(.*\n)*.*window\.OEUtils/, 'window.OEUtils');
                script.textContent = 'try{\n' + str + '\n}catch(e){ window.ev_parseFailed = true}'
                document.head.appendChild(script);
                document.head.removeChild(script);
                if (window.ev_parseFailed) {
                    window.ev_parseFailed = false;
                    return null
                }
                return true
            },
            _elementChanged: function () {
                if (this.element) {
                    var temp = this.element.querySelector('template');
                    this.set('templateContainers', [].map.call(temp.content.querySelectorAll('[id]'),
                        function (d) {
                            return d.getAttribute('id')
                        }));
                    if (OEUtils.Metamorph) {
                        OEUtils.Metamorph(temp, this.metaData, {});
                    }
                    var preview = document.createElement('div');
                    var binder = document.createElement('template');
                    binder.setAttribute('is', 'dom-bind');

                    var styleTags = temp.content.querySelectorAll('style');
                    [].forEach.call(styleTags, function (sty) {
                        sty.setAttribute('scoped', '');
                        preview.appendChild(sty);
                    });
                    OEUtils.scopeStyles && OEUtils.scopeStyles(preview);

                    while (temp.content.childNodes.length > 0) {
                        preview.appendChild(temp.content.childNodes[0]);
                    }
                    binder.content.appendChild(preview);
                    this.$.previewBox.innerHTML = "";
                    Polymer.dom.flush();
                    this.$.previewBox.innerHTML = binder.outerHTML;
                    Polymer.dom.flush();
                }
            },
            _handleClick: function (e) {
                var targetField = [].find.call(e.path, function (ele) {
                    return ele && (ele !== this) && ele.hasAttribute && ele.hasAttribute('field-id')
                }.bind(this));
                var prev = this.querySelector('.current-selection');
                if (prev) {
                    prev.classList.remove('current-selection');
                }
                if (targetField) {
                    targetField.classList.add('current-selection');
                    this.fire('show-field-setting', targetField.getAttribute('field-id'))
                } else {
                    this.fire('show-field-setting', null);
                }
            }
        })
    </script>
</dom-module>