<!--
Â©2015-2016 EdgeVerve Systems Limited (a fully owned Infosys subsidiary), Bangalore, India. All Rights Reserved.
-->
<link rel="import" href="../elements/studio-bottom-panel.html">
<link rel="import" href="ui-component-detail.html">
<link rel="import" href="ui-component-list.html">
<link rel="import" href="ui-component-editor.html">
<dom-module id="ui-component-manager">
    <template>
        <style>
             :host {
                position: relative;
                display: block;
                box-sizing: border-box;
            }

            .component-container {
                height: 100vh;
            }

        </style>
        <div class="component-container layout vertical">
            <div class="component-workspace layout horizontal flex">
                <ui-component-detail id="detail" component="{{workingComponent}}" template-containers="{{containerList}}" meta-data="{{metaData}}"
                    class="flex-3"></ui-component-detail>
                <iron-collapse horizontal class="flex-1" opened="[[showActions]]">
                    <ui-component-editor id="editor" class="flex-1" component="{{workingComponent}}" template-list="{{templateList}}" containers="[[containerList]]"
                        meta-data="{{metaData}}"></ui-component-editor>
                </iron-collapse>
            </div>
            <studio-bottom-panel>
                <ui-component-list id="componentLister" template-list="{{templateList}}" on-page-selected="pageSelectedHandle" class="flex"></ui-component-list>
                <paper-icon-button hidden=[[!showActions]] icon="save" on-tap="_save"></paper-icon-button>
                <paper-icon-button hidden=[[!showActions]] icon="undo" disabled="[[_disableUndo(stackIndex)]]" on-tap="_undo"></paper-icon-button>
                <paper-icon-button hidden=[[!showActions]] icon="redo" disabled="[[_disableRedo(stackIndex)]]" on-tap="_redo"></paper-icon-button>
            </studio-bottom-panel>
        </div>
    </template>
    <script>
        Polymer({
            is: "ui-component-manager",
            properties: {
                templateList: {
                    type: Array
                }
            },
            listeners: {
                'component-updated': '_updateStack',
                'show-field-setting': '_handleFieldEdit'
            },
            observers: ['_componentStackObserver(stackIndex)'],
            behaviors: [
                CommonBehavior.EVAjaxBehavior
            ],
            attached: function () {
                this.set('showActions', false);
            },
            _save: function () {
                this.$.componentLister.updateComponent(this.workingComponent);
            },
            _handleFieldEdit: function (e) {
                this.$.editor.showFieldEditor(e.detail);
            },
            _undo: function () {
                this.set('stackIndex', this.stackIndex - 1);
            },
            _redo: function () {
                this.set('stackIndex', this.stackIndex + 1);
            },
            _disableUndo: function (stackIndex) {
                return stackIndex === 0;
            },
            _disableRedo: function (stackIndex) {
                return stackIndex === (this.componentStack.length - 1);
            },
            _componentStackObserver: function () {
                if (this.stackIndex < 0) {
                    return;
                }
                var comp = this.componentStack[this.stackIndex];
                this.set('workingComponent', OEUtils.deepCloneJSON(comp));
            },
            pageSelectedHandle: function (e) {
                var self = this;
                var comp = e.detail;
                comp.fields = comp.fields || [];
                comp.excludeFields = comp.excludeFields || [];
                this.set('uiComponent', comp);
                this.set('showActions', true);
                this.set('componentStack', []);
                this.set('stackIndex', -1);
                this.fire('component-updated', e.detail);
            },
            _updateStack: function (e) {
                this.set('componentStack.' + (this.stackIndex + 1), OEUtils.deepCloneJSON(e.detail));
                this.set('stackIndex', this.stackIndex + 1);
                console.log("Stack updated ", this.stackIndex);
            }
        })
    </script>
</dom-module>