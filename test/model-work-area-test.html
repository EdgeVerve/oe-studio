<!-- Â©2015-2016 EdgeVerve Systems Limited (a fully owned Infosys subsidiary), Bangalore, India. All Rights Reserved.
The EdgeVerve proprietary software program ("Program"), is protected by copyrights laws, international treaties and other pending or existing intellectual property rights in India, the United States and other countries.
The Program may contain/reference third party or open source components, the rights to which continue to 
remain with the applicable third party licensors or the open source community as the case may be and nothing 
here transfers the rights to the third party and open source components, except as expressly permitted. 
Any unauthorized reproduction, storage, transmission in any form or by any means (including without limitation to electronic, mechanical, printing, photocopying, recording or  otherwise), or any distribution of this Program,or any portion of it, may result in severe civil and criminal penalties, and will be prosecuted to the maximum extent possible under the law. -->
<!doctype html>
<!--
        @author : Gowtham_D02
        @title  : Test cases for model-work-area polymer element
    -->
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/test-helpers.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>
  <script src="../../fakerest/dist/FakeRest.min.js"></script>
  <!-- importing dependent elements -->
  <link rel="import" href="../all-imports.html">
</head>

<body>
  <!-- You can use the document as a place to set up your fixtures. -->
  <test-fixture id="model-work-area">
    <template>
            <model-work-area></model-work-area>
        </template>
  </test-fixture>
  <script>
    HTMLImports.whenReady(function() {
      OEUtils.geturl = function(url) {
        return url;
      }
    });

    suite('<model-work-area>', function() {

      var workArea;
      var server;

      setup(function() {
        server = sinon.fakeServer.create();
        server.autoRespond = true;
        server.respondImmediately = true;


        var modelList = [{
          'properties': [{
            'type': 'string',
            '__name__': 'name'
          }, {
            'type': 'number',
            '__name__': 'age'
          }],
          'readonly': false,
          'name': 'Customer',
          'description': 'customer model',
          'plural': 'Customers',
          'base': 'BaseEntity',
          'strict': true,
          'public': true,
          'idInjection': false,
          'validateUpsert': false,
          'validations': [],
          'relations': [],
          'acls': [],
          'methods': [],
          'dataSourceName': '',
          'autoscope': [],
          'id': '578f39c1701c47800979d789',
          '_type': 'ModelDefinition',
          '_createdBy': 'admin',
          '_modifiedBy': 'admin',
          '_createdOn': '2016-07-20T08:43:45.611Z',
          '_modifiedOn': '2016-07-20T08:47:11.722Z',
          'scope': {},
          '_version': '937c0403-9e76-41c4-ae76-0c0b0aa33aa9',
          '_isDeleted': false,
          'evValidations': [],
          'mixins': {
            'ObserverMixin': true,
            'HistoryMixin': true,
            'EvCacheMixin': true,
            'ModelValidations': true,
            'ExpressionAstPopulatorMixin': true,
            'EvAuditFieldsMixin': true,
            'EvDatasourceJuggler': true,
            'DataPersonalizationMixin': true,
            'ServicePersonalizationMixin': true,
            'SwitchDatasourceMixin': true,
            'EvVersionMixin': false,
            'EvRemoteMethodMixin': false,
            'BusinessRuleMixin': true,
            'SoftDeleteMixin': true
          },
          'mongodb': {
            'collection': 'Customer'
          },
          'checked': false
        }, {
          'properties': [{
            'type': 'string',
            '__name__': 'accountNo'
          }, {
            'type': 'number',
            '__name__': 'amount'
          }],
          'readonly': false,
          'name': 'Account',
          'description': '',
          'plural': 'Accounts',
          'base': 'BaseEntity',
          'strict': true,
          'public': true,
          'idInjection': false,
          'validateUpsert': false,
          'validations': [],
          'relations': [],
          'acls': [],
          'methods': [],
          'dataSourceName': '',
          'autoscope': [],
          'id': '578f3a5f701c47800979d78a',
          '_type': 'ModelDefinition',
          '_createdBy': 'admin',
          '_modifiedBy': 'admin',
          '_createdOn': '2016-07-20T08:46:23.197Z',
          '_modifiedOn': '2016-07-20T08:46:23.197Z',
          'scope': {},
          '_version': 'c1ccce81-778f-4e18-8f04-832ca4476915',
          '_isDeleted': false,
          'evValidations': [],
          'mixins': {
            'ObserverMixin': true,
            'HistoryMixin': true,
            'EvCacheMixin': true,
            'ModelValidations': true,
            'ExpressionAstPopulatorMixin': true,
            'EvAuditFieldsMixin': true,
            'EvDatasourceJuggler': true,
            'DataPersonalizationMixin': true,
            'ServicePersonalizationMixin': true,
            'SwitchDatasourceMixin': true,
            'EvVersionMixin': false,
            'EvRemoteMethodMixin': false,
            'BusinessRuleMixin': true,
            'SoftDeleteMixin': true
          },
          'mongodb': {
            'collection': 'Account'
          },
          'checked': false
        }];
        var viewList = [{
          'name': 'CustomerView',
          'models': [{
            'id': '578f39c1701c47800979d789',
            'top': '63px',
            'left': '67px'
          }],
          'id': '578f40fa701c47800979d78c',
          '_type': 'ModelView',
          '_createdBy': 'admin',
          '_modifiedBy': 'admin',
          '_createdOn': '2016-07-20T09:14:34.018Z',
          '_modifiedOn': '2016-07-20T09:14:34.018Z',
          'scope': {},
          '_version': '14c08817-b11c-4164-be8f-fb050a5c4698',
          '_isDeleted': false
        }]


        server.respondWith('GET', /api\/ModelDefinitions/, function(req) {
          req.respond(200, {
            'Content-Type': 'application/json'
          }, JSON.stringify(modelList))
        });

        server.respondWith('PUT', /api\/*/, function(req) {
          req.respond(200, {
            'Content-Type': 'application/json'
          }, req.requestBody)
        });

        server.respondWith('POST', /api\/*/, function(req) {
          var resp = JSON.parse(req.requestBody);
          resp.id = '1421876-128378234824-123'
          req.respond(200, {
            'Content-Type': 'application/json'
          }, JSON.stringify(resp))
        });
        server.respondWith('DELETE', /api\/*/, function(req) {
          var resp = {
            'count': 1
          };
          req.respond(200, {
            'Content-Type': 'application/json'
          }, JSON.stringify(resp))
        });
        workArea = fixture('model-work-area');
        workArea.set('viewList',viewList);
        var msgHandler = document.createElement('oe-message-handler');
        msgHandler.id = 'toast';
        msgHandler.fitBottom = true;
        msgHandler.duration = 5000;
        workArea.appendChild(msgHandler);
        Polymer.dom(workArea.root).flush();
      });

      teardown(function() {
        server.restore();
      });

      test('Inital state when no parameters are set', function(done) {
        flush(function() {
          workArea.fetchModels(function(){
          expect(workArea.modelList).to.be.array;
          flush(function() {
            expect(workArea.modelList.length).to.be.equal(2);
            done();
          })
          });
        })
      })
      test('listen for toggle-bg event', function(done) {
        flush(function() {
          workArea.showGridBg = false;
          workArea.fire('toggle-bg', true);
          flush(function() {
            assert.equal(workArea.showGridBg, true);
            workArea.fire('toggle-bg', false);
            flush(function() {
              assert.equal(workArea.showGridBg, false);
              done();
            })
          })
        })
      })
      test('listen for toggle-grid-sidemenu event', function(done) {
        flush(function() {
          workArea.$.expandBar.opened = true;
          workArea.fire('toggle-grid-sidemenu', true);
          flush(function() {
            assert.equal(workArea.$.expandBar.opened, false);
            workArea.fire('toggle-grid-sidemenu', false);
            flush(function() {
              assert.equal(workArea.$.expandBar.opened, true);
              done();
            })
          })
        })
      })
      test('load/unload a model container into workspace', function(done) {
        flush(function() {
          assert.equal(workArea.workSpaceModelList.length, 0);
          var sideBar = Polymer.dom(workArea.root).querySelector('#model-side-nav');
          sideBar.set('modelList',workArea.modelList);
          var modelItem = Polymer.dom(sideBar.root).querySelectorAll('.model-list-item');

          modelItem[0].click();
          modelItem[1].click();
          flush(function() {
            assert.equal(workArea.workSpaceModelList.length, 2);
            modelItem[0].click();
            modelItem[1].click();
            flush(function() {
              assert.equal(workArea.workSpaceModelList.length, 0);
              done();
            })
          })
        })
      })
      test('load/unload/update a View into workspace', function(done) {
        workArea.fetchModels(function(){
        flush(function() {
          assert.equal(workArea.workSpaceModelList.length, 0);
          var sideBar = Polymer.dom(workArea.root).querySelector('#model-side-nav');
          var modelItem = Polymer.dom(sideBar.root).querySelectorAll('.model-list-item');
          var viewItem = Polymer.dom(sideBar.root).querySelectorAll('.view-item');
          viewItem[0].click();
          flush(function() {
            expect(workArea._tabList.length).to.be.equal(2);
            assert.equal(workArea.workSpaceModelList.length, 1);
            modelItem[0].click();
            viewItem[0].click();
            var msgHandler = workArea.childNodes[workArea.childNodes.length - 1];
            var confirmToast = Polymer.dom(msgHandler.root).querySelector('paper-toast#confirm');
            var okBtn = confirmToast.querySelector('paper-button#ok');
            okBtn.click();
            flush(function() {
              assert.equal(workArea.workSpaceModelList.length, 1);
              modelItem[0].click();
              flush(function() {
                var closeTabBtns = Polymer.dom(workArea.root).querySelectorAll('.tab-lister .tab-name #close-tab-icon');
                closeTabBtns[1].click();
                var msgHandler = workArea.childNodes[workArea.childNodes.length - 1];
                var confirmToast = Polymer.dom(msgHandler.root).querySelector('paper-toast#confirm');
                var okBtn = confirmToast.querySelector('paper-button#ok');
                okBtn.click();
                flush(function() {
                  expect(workArea.viewList[0].models.length).to.be.equal(2);
                  done();
                })
              })
            })
          })
        })
        });
      })
      test('test for adding and saving views', function(done) {
        workArea.fetchModels(function(){
        flush(function() {
          assert.equal(workArea.workSpaceModelList.length, 0);
          var sideBar = Polymer.dom(workArea.root).querySelector('#model-side-nav');
          var modelItem = Polymer.dom(sideBar.root).querySelectorAll('.model-list-item');
          modelItem[0].querySelector('.modelview').click();
          flush(function() {
            expect(workArea._tabList.length).to.be.equal(2);
            assert.equal(workArea.workSpaceModelList.length, 1);
            assert.equal(workArea.showButtons, true);
            workArea.querySelector('#save-as-view-btn').click();
            flush(function() {
              assert(workArea.$.addView.$.addNewViewDialog.opened, true);
              workArea.$.addView.$.addview.click();
              flush(function() {
                assert.equal(workArea.viewList.length, 2);
                modelItem[1].click();
                flush(function() {
                  var closeTabBtns = Polymer.dom(workArea.root).querySelectorAll('.tab-lister .tab-name #close-tab-icon');
                  closeTabBtns[1].click();
                  var msgHandler = workArea.childNodes[workArea.childNodes.length - 1];
                  var confirmToast = Polymer.dom(msgHandler.root).querySelector('paper-toast#confirm');
                  var okBtn = confirmToast.querySelector('paper-button#ok');
                  okBtn.click();
                  flush(function() {
                    assert.equal(workArea.viewList.length, 2);
                    expect(workArea.viewList[1].models.length).to.be.equal(2);
                    done();
                  })
                })
              })
            })
          })
        })
        });
      })
      test('Create,switch and close operation on tabs', function(done) {
        flush(function() {
          var sideBar = Polymer.dom(workArea.root).querySelector('#model-side-nav');
          var modelItem = Polymer.dom(sideBar.root).querySelectorAll('.model-list-item');
          modelItem[0].click();
          modelItem[1].click();
          expect(workArea._tabList.length).to.be.equal(1);
          flush(function() {
            assert.equal(workArea.workSpaceModelList.length, 2);
            var newTabBtn = Polymer.dom(workArea.root).querySelector('.add-empty-tab iron-icon');
            newTabBtn.click();
            flush(function() {
              assert.equal(workArea.workSpaceModelList.length, 0);
              expect(workArea._tabList.length).to.be.equal(2);
              newTabBtn.click();
              flush(function() {
                expect(workArea._tabList.length).to.be.equal(3);
                var TabList = Polymer.dom(workArea.root).querySelectorAll('.tab-lister .tab-name');
                expect(workArea._activeTabIndex).to.be.equal(2);
                TabList[0].click();
                flush(function() {
                  expect(workArea._activeTabIndex).to.be.equal(0);
                  assert.equal(workArea.workSpaceModelList.length, 2);
                  var closeTabBtns = Polymer.dom(workArea.root).querySelectorAll('.tab-lister .tab-name #close-tab-icon');
                  closeTabBtns[2].click();
                  flush(function() {
                    expect(workArea._activeTabIndex).to.be.equal(1);
                    expect(workArea._tabList.length).to.be.equal(2);
                    assert.equal(workArea.workSpaceModelList.length, 0);
                    closeTabBtns[1].click();
                    flush(function() {
                      expect(workArea._activeTabIndex).to.be.equal(0);
                      expect(workArea._tabList.length).to.be.equal(1);
                      assert.equal(workArea.workSpaceModelList.length, 2);
                      closeTabBtns[0].click();
                      flush(function() {
                        expect(workArea._activeTabIndex).to.be.equal(0);
                        expect(workArea._tabList.length).to.be.equal(1);
                        assert.equal(workArea.workSpaceModelList.length, 2);
                        modelItem[0].querySelector('.model-detail').click();
                        flush(function() {
                          var closeTabBtns = Polymer.dom(workArea.root).querySelectorAll('.tab-lister .tab-name #close-tab-icon');
                          closeTabBtns[1].click();
                          flush(function() {
                            expect(workArea._activeTabIndex).to.be.equal(0);
                            expect(workArea._tabList.length).to.be.equal(1);
                            done();
                          })
                        })
                      })
                    })

                  })
                })
              })
            })
          })
        })
      })
      test('Create a new model', function(done) {
        flush(function() {
          var sideBar = Polymer.dom(workArea.root).querySelector('#model-side-nav');
          var modelItem = Polymer.dom(sideBar.root).querySelectorAll('.model-list-item');
          modelItem[0].click();
          flush(function() {
            var menuBtn = Polymer.dom(workArea.root).querySelector('work-area-menu');
            var createModelBtn = Polymer.dom(menuBtn.root).querySelector('#create-model');
            createModelBtn.click();
            assert.equal(workArea.workSpaceModelList.length, 1);
            flush(function() {
              var Savedialog = Polymer.dom(workArea.root).querySelector('#createmodeldialog');
              var newModel = {
                'name': 'MyAccount',
                'plural': 'MyAccounts',
                'description': '',
                'base': 'Account',
                'idInjection': false,
                'strict': true,
                'properties': [{
                  'newProp': true,
                  '__name__': 'accountNumber',
                  'type': 'string',
                  'min': '6',
                  'max': '6',
                  'required': true
                }],
                'validations': [],
                'evValidations': [{
                  'newProp': true,
                  '__name__': 'balance',
                  'type': 'reference',
                  'refModel': 'Account',
                  'errorCode': '101',
                  'referenceWhere': 'acc'
                }],
                'relations': [],
                'acls': [{
                  'newacl': true,
                  'propertyValue': '*',
                  'accessType': '*',
                  'checked': false,
                  'principalType': 'ROLE',
                  'principalId': '$owner',
                  'permission': 'ALLOW'
                }],
                'methods': [],
                'checked': false,
                'dataSourceName': '',
                'autoscope': []
              }
              Savedialog.set('vm', newModel);
              flush(function() {
                var lastStep = Polymer.dom(Savedialog.root).querySelector('.stepper #step_4');
                var lastSave = Polymer.dom(Savedialog.root).querySelector('.dialog-footer #nextbtn');
                var saveBtn = Polymer.dom(Savedialog.root).querySelector('.dialog-footer #savebtn');
                lastStep.click();
                flush(function() {
                  lastSave.click();
                  flush(function() {
                    saveBtn.click();
                    flush(function() {
                      setTimeout(function() {
                        assert.equal(workArea.workSpaceModelList.length, 2);
                        done();
                      }, 1000)
                    })
                  })
                })
              })
            })
          })
        })
      })
      test('edit Model to add a relation', function(done) {
        flush(function() {
          var sideBar = Polymer.dom(workArea.root).querySelector('#model-side-nav');
          var modelItem = Polymer.dom(sideBar.root).querySelectorAll('.model-list-item');
          modelItem[0].click();
          modelItem[1].click();
          flush(function() {
            var modelContainers = Polymer.dom(workArea.root).querySelectorAll('model-container');
            var customerContainer = modelContainers[1];
            Polymer.dom(customerContainer.root).querySelector('#edit-model-starter').click();
            flush(function() {
              var Savedialog = Polymer.dom(workArea.root).querySelector('#createmodeldialog');
              Savedialog.push('vm.relations', {
                'type': 'hasMany',
                'model': 'Account',
                '__name__': 'accounts'
              });
              flush(function() {
                var lastStep = Polymer.dom(Savedialog.root).querySelector('.stepper #step_4');
                var lastSave = Polymer.dom(Savedialog.root).querySelector('.dialog-footer #nextbtn');
                var saveBtn = Polymer.dom(Savedialog.root).querySelector('.dialog-footer #savebtn');
                lastStep.click();
                flush(function() {
                  lastSave.click();
                  flush(function() {
                    saveBtn.click();

                    flush(function() {
                      var SaveAllModels = Polymer.dom(workArea.root).querySelector('#save-all-models-btn');
                      SaveAllModels.click();
                      flush(function() {
                        setTimeout(function() {
                          workArea._showExistingRelations();
                          assert.equal(customerContainer.modelObj.relations.length, 1);
                          done();
                        }, 2000)

                      })
                    })

                  })
                })
              })
            })
          })

        })
      })
      test('operations on model-container', function(done) {
        flush(function() {
          var msgHandler = workArea.childNodes[workArea.childNodes.length - 1];
          var confirmToast = Polymer.dom(msgHandler.root).querySelector('paper-toast#confirm');
          var okBtn = confirmToast.querySelector('paper-button#ok');
          var cancelBtn = confirmToast.querySelector('paper-button#cancel');
          var sideBar = Polymer.dom(workArea.root).querySelector('#model-side-nav');
          var modelItem = Polymer.dom(sideBar.root).querySelectorAll('.model-list-item');
          modelItem[0].click();
          modelItem[1].click();
          flush(function() {
            var modelContainers = Polymer.dom(workArea.root).querySelectorAll('model-container');
            var dataDialog = Polymer.dom(workArea.root).querySelector('model-definition-dialog')
            var ruleDialog = Polymer.dom(workArea.root).querySelector('#addRuleDlg')
            var customerContainer = modelContainers[1];
            Polymer.dom(customerContainer.root).querySelector('#personalization-rule-starter').click();

            flush(function() {
              assert.isTrue(Polymer.dom(ruleDialog.root).querySelector('paper-dialog').opened);
              Polymer.dom(ruleDialog.root).querySelector('#close-dialog').click();
              Polymer.dom(customerContainer.root).querySelector('#edit-model-starter').click();
              flush(function() {
                assert.isTrue(Polymer.dom(dataDialog.root).querySelector('paper-dialog').opened);
                Polymer.dom(dataDialog.root).querySelector('#model-definition-dialog-custom-save').click();
                Polymer.dom(customerContainer.root).querySelector('#clone-model-starter').click();
                flush(function() {
                  assert.isTrue(Polymer.dom(dataDialog.root).querySelector('paper-dialog').opened);
                  Polymer.dom(dataDialog.root).querySelector('#model-definition-dialog-custom-save').click();
                  Polymer.dom(customerContainer.root).querySelector('#delete-model-starter').click();
                  flush(function() {
                    cancelBtn.click();
                    customerContainer.$$('#toggle-detail-view').click();
                    flush(function() {
                      assert.equal(workArea.workSpaceModelList.length, 2);
                      customerContainer.$$('#view-detail-view').click();
                      flush(function() {
                        assert.equal(workArea.$.detailDialog.$.modelDetailDialog.opened, true);
                        workArea.$.detailDialog.hideDialog();
                        var closeModelContainer = Polymer.dom(customerContainer.root).querySelector('#close-container');
                        closeModelContainer.click();
                        flush(function() {
                          assert.equal(workArea.workSpaceModelList.length, 1);
                          modelContainers[0].querySelector('#delete-model-starter').click();
                          flush(function() {
                            okBtn.click();
                            flush(function() {
                              workArea.async(function() {
                                assert.equal(workArea.workSpaceModelList.length, 0);
                                done();
                              })
                            })
                          })
                        })
                      })
                    })
                  })
                })
              })
            })
          })
        })
      })
      test('zoom in and zoom out', function(done) {
        flush(function() {
          workArea.set('_selectedTab', {
            'name': 'untitled_view_1',
            'models': [],
            'view': null,
            'type': 'view',
            'currentZoom': 1
          });
          var ZoomInBtn = Polymer.dom(workArea.root).querySelector('#zoom-in');
          var ZoomOutBtn = Polymer.dom(workArea.root).querySelector('#zoom-out');
          var CurrentZoomLevel = workArea._selectedTab.currentZoom;
          assert.equal(workArea._selectedTab.currentZoom, 1);
          flush(function() {
            MockInteractions.tap(ZoomInBtn);
            flush(function() {
              assert.equal(workArea._selectedTab.currentZoom, (CurrentZoomLevel + 0.1));
              MockInteractions.tap(ZoomOutBtn);
              flush(function() {
                assert.equal(workArea._selectedTab.currentZoom, CurrentZoomLevel);
                done();
              })
            })
          })
        })
      })
      test('edit personalization rule', function(done) {
        flush(function() {
          var modelObj = {
            'properties': [{
              'type': 'string',
              '__name__': 'name'
            }, {
              'type': 'number',
              '__name__': 'age'
            }],
            'readonly': false,
            'name': 'Customer',
            'description': 'customer model',
            'plural': 'Customers',
            'base': 'BaseEntity',
            'strict': true,
            'public': true,
            'idInjection': false,
            'validateUpsert': false,
            'validations': [],
            'relations': [],
            'acls': [],
            'methods': [],
            'dataSourceName': '',
            'autoscope': [],
            'id': '578f39c1701c47800979d789',
            '_type': 'ModelDefinition',
            '_createdBy': 'admin',
            '_modifiedBy': 'admin',
            '_createdOn': '2016-07-20T08:43:45.611Z',
            '_modifiedOn': '2016-07-20T08:47:11.722Z',
            'scope': {},
            '_version': '937c0403-9e76-41c4-ae76-0c0b0aa33aa9',
            '_isDeleted': false,
            'evValidations': [],
            'mixins': {
              'ObserverMixin': true,
              'HistoryMixin': true,
              'EvCacheMixin': true,
              'ModelValidations': true,
              'ExpressionAstPopulatorMixin': true,
              'EvAuditFieldsMixin': true,
              'EvDatasourceJuggler': true,
              'DataPersonalizationMixin': true,
              'ServicePersonalizationMixin': true,
              'SwitchDatasourceMixin': true,
              'EvVersionMixin': false,
              'EvRemoteMethodMixin': false,
              'BusinessRuleMixin': true,
              'SoftDeleteMixin': true
            },
            'mongodb': {
              'collection': 'Customer'
            },
            'checked': false
          }
          var rule = {
            'modelName': 'Customer',
            'name': 'TestRule',
            'personalizationRule': {
              'mask': {
                'age': true
              }
            },
            'scope': {
              'deviceType': 'ios'
            },
            'id': 2,
            '_version': 2
          }
          workArea.addEventListener('edit-rule', function(e) {
            assert.equal(e.detail.modelObj.name, 'Customer')
            done();
          });
          workArea.fire('edit-rule', {
            'modelObj': modelObj,
            'rule': rule
          });
        })
      })
      test('listen to acl properties and relations in dialog event', function(done) {
        flush(function() {
          var modelObj = {
            'properties': [{
              'type': 'string',
              '__name__': 'name'
            }, {
              'type': 'number',
              '__name__': 'age'
            }],
            'readonly': false,
            'name': 'Customer',
            'description': 'customer model',
            'plural': 'Customers',
            'base': 'BaseEntity',
            'strict': true,
            'public': true,
            'idInjection': false,
            'validateUpsert': false,
            'validations': [],
            'relations': [],
            'acls': [],
            'methods': [],
            'dataSourceName': '',
            'autoscope': [],
            'id': '578f39c1701c47800979d789',
            '_type': 'ModelDefinition',
            '_createdBy': 'admin',
            '_modifiedBy': 'admin',
            '_createdOn': '2016-07-20T08:43:45.611Z',
            '_modifiedOn': '2016-07-20T08:47:11.722Z',
            'scope': {},
            '_version': '937c0403-9e76-41c4-ae76-0c0b0aa33aa9',
            '_isDeleted': false,
            'evValidations': [],
            'mixins': {
              'ObserverMixin': true,
              'HistoryMixin': true,
              'EvCacheMixin': true,
              'ModelValidations': true,
              'ExpressionAstPopulatorMixin': true,
              'EvAuditFieldsMixin': true,
              'EvDatasourceJuggler': true,
              'DataPersonalizationMixin': true,
              'ServicePersonalizationMixin': true,
              'SwitchDatasourceMixin': true,
              'EvVersionMixin': false,
              'EvRemoteMethodMixin': false,
              'BusinessRuleMixin': true,
              'SoftDeleteMixin': true
            },
            'mongodb': {
              'collection': 'Customer'
            },
            'checked': false
          }

          flush(function() {
            workArea.fire('add-property-in-dialog', modelObj);
            flush(function() {
              assert.equal(workArea.$.createmodeldialog.vm.name, 'Customer');
              workArea.fire('add-relation-in-dialog', modelObj);
              flush(function() {
                assert.equal(workArea.$.createmodeldialog.vm.name, 'Customer');
                workArea.fire('add-acl-in-dialog', modelObj);
                flush(function() {
                  assert.equal(workArea.$.createmodeldialog.vm.name, 'Customer');
                  done();
                })
              })
            })
          });
        })
      })
      test('test for rendering different views', function(done) {
        flush(function() {
          var sideBar = Polymer.dom(workArea.root).querySelector('#model-side-nav');
          var modelItem = Polymer.dom(sideBar.root).querySelectorAll('.model-list-item');
          modelItem[0].click();
          flush(function() {
            expect(workArea._activeTabIndex).to.be.equal(0);
            expect(workArea._tabList.length).to.be.equal(1);
            assert.equal(workArea.workSpaceModelList.length, 1);
            modelItem[0].querySelector('.modelview').click();
            flush(function() {
              expect(workArea._activeTabIndex).to.be.equal(1);
              expect(workArea._tabList.length).to.be.equal(2);
              modelItem[1].click();
              flush(function() {
                assert.equal(workArea.workSpaceModelList.length, 2);
                expect(workArea._activeTabIndex).to.be.equal(1);
                expect(workArea._tabList.length).to.be.equal(2);
                modelItem[0].querySelector('.data-manager').click();
                flush(function() {
                  expect(workArea._activeTabIndex).to.be.equal(2);
                  expect(workArea._tabList.length).to.be.equal(3);
                  assert.equal(workArea.workSpaceModelList.length, 0);
                  modelItem[0].querySelector('.model-detail').click();
                  flush(function() {
                    expect(workArea._activeTabIndex).to.be.equal(3);
                    expect(workArea._tabList.length).to.be.equal(4);
                    assert.equal(workArea.workSpaceModelList.length, 0);
                    done();
                  })
                })
              });
            });
          })
        })
      })
      test('listen to upload data event', function(done) {
        workArea.set('modelList', [{
          'properties': [{
            'type': 'object',
            '__name__': 'properties'
          }, {
            'type': 'boolean',
            '__name__': 'readonly'
          }, {
            'format': "^[0-9a-zA-Z\\^\\&\\'\\@\\{\\}\\[\\]\\,\\$\\=\\!\\-\\#\\(\\)\\.\\%\\+\\~\\_ ]+$",
            'type': 'string',
            '__name__': 'name'
          }, {
            'type': 'string',
            '__name__': 'description'
          }, {
            'format': "^[0-9a-zA-Z\\^\\&\\'\\@\\{\\}\\[\\]\\,\\$\\=\\!\\-\\#\\(\\)\\.\\%\\+\\~\\_ ]+$",
            'type': 'string',
            '__name__': 'plural'
          }, {
            'type': 'string',
            '__name__': 'base'
          }, {
            'type': 'boolean',
            '__name__': 'strict'
          }, {
            'defaultValue': true,
            'type': 'boolean',
            '__name__': 'public'
          }, {
            'type': 'boolean',
            '__name__': 'idInjection'
          }, {
            'type': 'boolean',
            '__name__': 'validateUpsert'
          }, {
            'type': 'array',
            'items': {
              'type': 'object'
            },
            '__name__': 'validations'
          }, {
            'type': 'object',
            '__name__': 'relations'
          }, {
            'type': 'array',
            'items': {
              'type': 'object'
            },
            '__name__': 'acls'
          }, {
            'type': 'object',
            '__name__': 'methods'
          }, {
            'defaultValue': 'db',
            'type': 'string',
            '__name__': 'dataSourceName'
          }, {
            'type': 'array',
            'items': {
              'type': 'string'
            },
            '__name__': 'autoscope'
          }, {
            'type': 'objectid',
            '__name__': 'id'
          }, {
            'length': 50,
            'type': 'string',
            '__name__': '_type'
          }, {
            'length': 50,
            'type': 'string',
            '__name__': '_createdBy'
          }, {
            'length': 50,
            'type': 'string',
            '__name__': '_modifiedBy'
          }, {
            'type': 'string',
            'format': 'date',
            '__name__': '_createdOn'
          }, {
            'type': 'string',
            'format': 'date',
            '__name__': '_modifiedOn'
          }, {
            'type': 'object',
            '__name__': 'scope'
          }, {
            'type': 'string',
            '__name__': '_version'
          }, {
            'type': 'boolean',
            '__name__': '_isDeleted'
          }],
          'readonly': false,
          'name': 'ModelDefinition',
          'plural': 'ModelDefinitions',
          'base': 'BaseEntity',
          'strict': false,
          'public': true,
          'idInjection': false,
          'validateUpsert': true,
          'validations': [],
          'relations': [],
          'acls': [{
            'accessType': 'WRITE',
            'principalType': 'ROLE',
            'principalId': '$unauthenticated',
            'permission': 'DENY'
          }],
          'methods': {},
          'dataSourceName': 'db',
          'autoscope': ['tenantId'],
          'id': '578e2892a45edc484e7631b8',
          '_type': 'ModelDefinition',
          '_createdBy': 'system',
          '_modifiedBy': 'system',
          '_createdOn': '2016-07-19T13:18:09.244Z',
          '_modifiedOn': '2016-07-19T13:18:09.244Z',
          'scope': {},
          '_version': '55480583-8d9c-461d-8f23-9ef7c8088f50',
          '_isDeleted': false,
          'evEnableBulkUpload': true,
          'evTrackHistory': true,
          'trackChanges': false,
          'mixins': {
            'ObserverMixin': true,
            'HistoryMixin': true,
            'EvCacheMixin': true,
            'ModelValidations': true,
            'ExpressionAstPopulatorMixin': true,
            'EvAuditFieldsMixin': true,
            'EvDatasourceJuggler': true,
            'DataPersonalizationMixin': true,
            'ServicePersonalizationMixin': true,
            'SwitchDatasourceMixin': true,
            'EvVersionMixin': true,
            'EvRemoteMethodMixin': true,
            'BusinessRuleMixin': true,
            'SoftDeleteMixin': true
          },
          'hidden': ['_tenantId', '_scope', '_autoScope', 'score', 'weight', '__oldVersion', 'filebased', '_autoscope', '_scope'],
          'isFrameworkModel': true,
          'mongodb': {
            'collection': 'ModelDefinition'
          },
          'checked': false,
          'evValidations': []
        }]);
        flush(function() {
          var menu = workArea.querySelector('#model-menu');
          var uploadBtn = menu.querySelector('#uploadmodels');
          uploadBtn.fire('tap');
          flush(function() {
            assert.equal(workArea.$.modelDataDialog.querySelector('paper-dialog').opened, true);
            workArea.$.modelDataDialog.hideDialog();
            done();
          })
        });
      })
      test('listen to edit-property event', function(done) {
        flush(function() {
          var sideBar = Polymer.dom(workArea.root).querySelector('#model-side-nav');
          var modelItem = Polymer.dom(sideBar.root).querySelectorAll('.model-list-item');
          modelItem[0].click();
          flush(function() {
            assert.equal(workArea.workSpaceModelList.length, 1);
            var modelContainer = workArea.querySelectorAll('model-container');
            var propList = modelContainer[0].querySelectorAll('.list-item');
            propList[0].querySelector('#edit-icon').click();
            flush(function() {
              var propBtn = modelContainer[0].querySelector('#validate-prop-btn');
              propBtn.click();
              flush(function() {
                assert.equal(workArea.$.addProperty.querySelector('paper-dialog').opened, true);
                workArea.$.addProperty.hideDialog();
                done();
              });
            })
          });
        })
      })
    });

  </script>
</body>

</html>
