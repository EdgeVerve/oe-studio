<!-- Â©2015-2016 EdgeVerve Systems Limited (a fully owned Infosys subsidiary), Bangalore, India. All Rights Reserved.
The EdgeVerve proprietary software program ("Program"), is protected by copyrights laws, international treaties and other pending or existing intellectual property rights in India, the United States and other countries.
The Program may contain/reference third party or open source components, the rights to which continue to 
remain with the applicable third party licensors or the open source community as the case may be and nothing 
here transfers the rights to the third party and open source components, except as expressly permitted. 
Any unauthorized reproduction, storage, transmission in any form or by any means (including without limitation to electronic, mechanical, printing, photocopying, recording or  otherwise), or any distribution of this Program,or any portion of it, may result in severe civil and criminal penalties, and will be prosecuted to the maximum extent possible under the law. -->
<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>
    <!-- importing dependent elements -->
    <link rel="import" href="../../all-imports.html">
    <!-- importing element to be tested -->
</head>

<body>
    <!-- You can use the document as a place to set up your fixtures. -->
    <test-fixture id="ui-page-list-fixture">
        <template>
            <ui-page-list>
            </ui-page-list>
        </template>
    </test-fixture>
    <script>
        OEUtils.designerData = OEUtils.designerData || {};
        OEUtils.designerData.elementList = OEUtils.designerData.elementList || []
        suite('<ui-page-list>', function () {
            var testElement;
            var server;
            var uiComponents = [{
                "name": "contact-form",
                "templateName": "default-form.html",
                "modelName": "Contact",
                "fields": ["FirstName", "LastName", "Email", "MobilePhone", {
                    "fieldId": "LeadSource",
                    "label": "Lead Source",
                    "uitype": "oe-combo",
                    "listdata": ["Web", "Phone Inquiry", "Partner Referral", "Purchased List",
                        "Other"
                    ],
                    "container": "fields"
                }, "LeadSource"],
                "polymerConfig": {
                    "listeners": {
                        "oe-route-change": "_routeChanged"
                    },
                    "functions": {
                        "_routeChanged": "function(event) { this.set('contact.CanTrigger', true); }"
                    }
                },
                "autoInjectFields": true,
                "excludeFields": ["CanTrigger"],
                "id": "b912967e-547f-4da1-9eef-6db8fefe9c19",
                "_type": "UIComponent",
                "_createdBy": "system",
                "_modifiedBy": "system",
                "_createdOn": "2017-07-28T05:26:13.557Z",
                "_modifiedOn": "2017-07-28T05:26:13.557Z",
                "_isDeleted": false,
                "_version": "e92f6386-c7f4-4bec-84c9-0eff5ce7af2f"
            }, {
                "name": "apply-loan",
                "templateName": "loan-template-1.html",
                "modelName": "LoanApplication",
                "autoInjectFields": true,
                "excludeFields": [],
                "id": "b919967e-547f-4da1-9eef-6db8fefe9c19",
                "_type": "UIComponent",
                "_createdBy": "system",
                "_modifiedBy": "system",
                "_createdOn": "2017-07-28T05:26:13.288Z",
                "_modifiedOn": "2017-07-28T05:26:13.288Z",
                "_isDeleted": false,
                "_version": "4bcc4e15-80fa-44f5-9d05-a39e04d30ddd"
            }];

            var templates = [{
                    "file": "blank-page.html",
                    "path": "client/bower_components/oe-studio/templates",
                    "content": "<div></div>\r\n",
                    "type": "html"
                },
                {
                    "file": "blank-template.html",
                    "path": "client/bower_components/oe-studio/templates",
                    "content": "<!--\r\n        @author Rohit_Khode\r\n        @description Blank Template\r\n-->\r\n<link rel=\"import\" href=\"/bower_components/meta-polymer/meta-polymer.html\">\r\n<link rel=\"import\" href=\"/bower_components/polymer/polymer.html\">\r\n\r\n<dom-module id=\":componentName\">\r\n  <style>\r\n     :host {\r\n      display: block;\r\n      padding: 8px;\r\n    }\r\n    \r\n    #content {\r\n      background: #fff;\r\n    }\r\n\r\n  </style>\r\n  <template>\r\n\t\t<div class=\"content\" id=\"content\">\r\n\r\n\t\t</div>\r\n\t</template>\r\n  <script>\r\n    MetaPolymer({\r\n      is: ':componentName'\r\n    });\r\n\r\n    <\/script>\r\n</dom-module>\r\n",
                    "type": "component"
                }
            ];

            var modelDefinitions = [{"name":"Admin"},{"name":"dev"},{"name":"BaseEntity"},{"name":"ModelDefinition"},{"name":"DataSourceDefinition"},{"name":"PersonalizationRule"},{"name":"DbTransaction"},{"name":"UIBase"},{"name":"UIMetadata"},{"name":"Validation"},{"name":"Field"},{"name":"UIRoute"},{"name":"userCredential"},{"name":"userIdentity"},{"name":"DataACL"},{"name":"Tenant"},{"name":"UserProfile"},{"name":"Literal"},{"name":"CacheManager"},{"name":"Error"},{"name":"EnumBase"},{"name":"NavigationLink"},{"name":"ChangeRequest"},{"name":"UIResource"},{"name":"TypeMapping"},{"name":"GridMetaData"},{"name":"GridConfig"},{"name":"GridColumnConfig"},{"name":"Email"},{"name":"RefCodeBase"},{"name":"OTP"},{"name":"Document"},{"name":"BusinessRule"},{"name":"JobScheduler"},{"name":"DataSourceMapping"},{"name":"LoggerConfig"},{"name":"AppConfig"},{"name":"DesignerPage"},{"name":"ModelView"},{"name":"UIManager"},{"name":"DesignerRule"},{"name":"UIComponent"},{"name":"UIElement"},{"name":"UIAttribute"},{"name":"BaseType"},{"name":"NodeRedFlow"},{"name":"ReconciliationEvent"},{"name":"BaseActorEntity"},{"name":"BaseJournalEntity"},{"name":"ActorActivity"},{"name":"State"},{"name":"EventHistory"},{"name":"BaseReplayableEntity"},{"name":"RoutingRules"},{"name":"DecisionTable"},{"name":"DocumentData"},{"name":"DesignerElement"},{"name":"MinimumState"},{"name":"SystemConfig"},{"name":"ModelRule"},{"name":"TrustedApp"},{"name":"Lock"},{"name":"PendingJournal"},{"name":"WorkflowBaseEntity"},{"name":"ProcessDefinition"},{"name":"ProcessInstance"},{"name":"Task"},{"name":"bpmndata"},{"name":"WorkflowDefinition"},{"name":"WorkflowInstance"},{"name":"WorkflowRequest"},{"name":"WorkflowManager"},{"name":"Activiti_Manager"},{"name":"Activiti_BaseEntity"},{"name":"Activiti_Account"},{"name":"Activiti_WorkflowRequest"},{"name":"WorkflowMapping"},{"name":"UserInfo"},{"name":"Address"},{"name":"Country"},{"name":"Product"},{"name":"Counter"},{"name":"container"},{"name":"Currency"},{"name":"Region"},{"name":"CustomerProfile"},{"name":"LoanType"},{"name":"EmploymentType"},{"name":"IncomeType"},{"name":"TransactionType"},{"name":"Transaction"},{"name":"IncomeDetail"},{"name":"EmploymentDetail"},{"name":"Loan"},{"name":"LoanApplication"},{"name":"Contact"},{"name":"AuthSession"},{"name":"BaseUser"},{"name":"AppUser"},{"name":"BaseACL"},{"name":"BaseRoleMapping"},{"name":"BaseRole"}];

            var modelMeta = {"CustomerProfile":{"id":"CustomerProfile","plural":"CustomerProfiles","resturl":"/api/CustomerProfiles","properties":{"firstName":{"type":"string","required":true},"lastName":{"type":"string"},"region":{"type":"string","refcodetype":"Region"},"dateOfBirth":{"type":"date"},"address":{"type":"model","modeltype":"Address"},"phoneNumber":{"type":"string","pattern":"^[0-9]{10}$"},"image":{"type":"string"},"userId":{"type":"objectid","required":true},"department":{"type":"string","required":false},"id":{"type":"objectid","id":1,"generated":true},"_type":{"type":"string","length":50,"required":true},"_createdBy":{"type":"string","length":50,"required":true},"_modifiedBy":{"type":"string","length":50,"required":true},"_createdOn":{"type":"timestamp","required":true,"evtype":"timestamp"},"_modifiedOn":{"type":"timestamp","required":true,"evtype":"timestamp"},"scope":{"type":"object","required":false},"_isDeleted":{"type":"boolean","default":false},"_oldVersion":{"type":"string"},"_version":{"type":"string","index":{"unique":true,"background":true},"required":true},"_requestId":{"type":"string"},"_newVersion":{"type":"string"}},"relations":{"user":{"name":"user","type":"belongsTo","modelFrom":"CustomerProfile","keyFrom":"userId","modelTo":"AppUser","keyTo":"id","multiple":false}}}};
            setup(function () {
                server = sinon.fakeServer.create();
                server.autoRespond = true;
                server.respondImmediately = true;
                server.respondWith('POST', /api\/UIComponents/, function (req) {
                    var body =
                        JSON.parse(req.requestBody);
                    body.id = "asdasdaszxvx";
                    req.respond(200, {
                        'Content-Type': 'application/json'
                    }, JSON.stringify(body));
                });
                server.respondWith('PUT', /api\/UIComponents/, function (req) {
                    req.respond(200, {
                        'Content-Type': 'application/json'
                    }, req.requestBody);
                });
                server.respondWith('GET', /api\/UIComponents/, function (req) {
                    req.respond(200, {
                        'Content-Type': 'application/json'
                    }, JSON.stringify(uiComponents));
                });
                server.respondWith('DELETE', /api\/UIComponents\/*/, function (req) {
                    req.respond(200, {
                        'Content-Type': 'application/json'
                    }, req.requestBody);
                });
                server.respondWith('GET', /designer\/templates/,
                    function (req) {
                        req.respond(200, {
                            'Content-Type': 'application/json'
                        }, JSON.stringify(templates));
                    });
                 server.respondWith('GET', /api\/ModelDefinitions/, function (req) {
                    if(req.url.match('modelmeta')){
                        req.respond(200, {
                            'Content-Type': 'application/json'
                        }, JSON.stringify(modelMeta));
                     }else{
                        req.respond(200, {
                            'Content-Type': 'application/json'
                        }, JSON.stringify(modelDefinitions));
                     }
                });
                testElement = fixture('ui-page-list-fixture');
            });
            test('Initial state', function (done) {
                flush(function () {
                    assert.equal(testElement.templateList.length, 2);
                    assert.equal(testElement.componentList.length, 2);
                    assert.equal(testElement.polymerCount, 2);
                    assert.equal(testElement.staticCount, 0);
                    done();
                });
            });

            test('Create a Static Page', function (done) {
                testElement.addEventListener('page-selected', function (e) {
                    var detail = e.detail;
                     assert.equal(detail.name, 'testStaticPage');
                     assert.equal(detail.isPolymerElement, false);
                     assert.equal(testElement.staticCount, 1);
                    done();
                })
                flush(function () {
                    assert.equal(testElement.staticCount, 0);
                    var createComponent = testElement.querySelector('ui-create-component');
                    var addTrigger = testElement.querySelector('#add-component-panel');
                    addTrigger.click();
                    flush(function () {
                        createComponent.set('componentType', 1);
                        var prevBtn = createComponent.querySelector(
                            '.step-navigation-panel .secondary-btn');
                        var nextBtn = createComponent.querySelector(
                            '.step-navigation-panel .primary-btn');
                        flush(function () {
                            nextBtn.click();
                            flush(function () {
                                createComponent.set('elementName',
                                    'testElement.html');
                                flush(function () {
                                    nextBtn.click();
                                    flush(function () {
                                        var simpleTemp =
                                            createComponent
                                            .querySelector(
                                                '.step-4 paper-radio-button'
                                            );
                                        simpleTemp.click();
                                        flush(function () {
                                            prevBtn
                                                .click();
                                            flush
                                                (
                                                    function () {
                                                        createComponent
                                                            .set(
                                                                'elementName',
                                                                'testStaticPage'
                                                            );
                                                        flush
                                                            (
                                                                function () {
                                                                    nextBtn
                                                                        .click();
                                                                    flush
                                                                        (
                                                                            function () {
                                                                                nextBtn
                                                                                    .click();
                                                                            }
                                                                        )
                                                                }
                                                            )
                                                    }
                                                )
                                        })
                                    })
                                })
                            })
                        })
                    })
                })
            });

            test('Create a Polymer Page', function (done) {
                testElement.addEventListener('page-selected', function (e) {
                    var detail = e.detail;
                     assert.equal(detail.name, 'test-element');
                     assert.equal(detail.isPolymerElement, true);
                     assert.equal(testElement.polymerCount, 3);
                    done();
                })
                flush(function () {
                    assert.equal(testElement.polymerCount, 2);
                    var createComponent = testElement.querySelector('ui-create-component');
                    var addTrigger = testElement.querySelector('#add-component-panel');
                    addTrigger.click();
                    flush(function () {
                        createComponent.set('componentType', 0);
                        var prevBtn = createComponent.querySelector(
                            '.step-navigation-panel .secondary-btn');
                        var nextBtn = createComponent.querySelector(
                            '.step-navigation-panel .primary-btn');
                        flush(function () {
                            nextBtn.click();
                            flush(function () {
                                createComponent.set('elementName','test-element');
                                createComponent.set('showModelBinder',true);
                                flush(function () {
                                    nextBtn.click();
                                    flush(function () {
                                       var modelSelector =createComponent.querySelector('.step-3 oe-combo');
                                       modelSelector.set('value',"CustomerProfile");
                                       modelSelector.fire('change');
                                       flush(function(){
                                            nextBtn.click();
                                            flush(function(){
                                                var simpleTemp =createComponent.querySelector('.step-4 paper-radio-button');
                                                 simpleTemp.click();
                                                 flush(function(){
                                                     nextBtn.click();
                                                 })
                                            })
                                       })
                                    })
                                })
                            })
                        })
                    })
                })
            });

            test('Clone Polymer Element',function(done){
                flush(function(){
                    var pageItem = testElement.querySelector('.page-item');
                    pageItem.click();
                    flush(function(){
                        testElement.$.clonePagePanel.click();
                        flush(function(){
                            var cloneComponent =testElement.querySelector('ui-clone-page');
                            cloneComponent.addEventListener('clone-page',function(e){
                                var pageDetail = e.detail;
                                 assert.equal(pageDetail.scope.location, "USA");
                                 done();
                            })
                            cloneComponent.set('scope',{"location":"USA"});
                            flush(function(){
                                cloneComponent.$.clonePageBtn.click();
                            })
                        })
                    })
                })
            });

            test('Delete Polymer Element',function(done){
                testElement.addEventListener('page-deleted',function(e){
                    assert.equal(testElement.polymerCount, 1);
                    assert.equal(e.detail.name, "contact-form");
                    done();
                });
                flush(function(){
                    assert.equal(testElement.polymerCount, 2);
                    var pageItem = testElement.querySelector('.page-item');
                    var deleteIcon = pageItem.querySelector('.options [icon="delete"]');
                    deleteIcon.click();
                })
            });
        });
    </script>
</body>

</html>