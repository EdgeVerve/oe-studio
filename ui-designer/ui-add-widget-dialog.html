<dom-module id="ui-add-widget-dialog">
	<template>
		<style>
			#dialog {
				min-width: 300px;
			}

			#delete-btn{
				color: red;
			}
		</style>

		<paper-dialog id="dialog" modal>
			<div class="dialog-header">[[display.heading]]</div>
			<div class="dialog-content">
				<form is="iron-form" id="form">
					<label class="helper-text">Widget Name</label>
					<oe-input no-label-float value="{{config.name}}" required></oe-input>
					<label class="helper-text">Widget Description</label>
					<oe-textarea no-label-float value="{{config.description}}" required></oe-textarea>
					<icon-picker selected-icon="{{config.icon}}"></icon-picker>
					<oe-combo required listdata="[[display.widgetTypes]]" value="{{config.category}}" label="Category"></oe-combo>
				</form>
			</div>
			<div class="dialog-footer layout horizontal justified">
				<paper-button on-tap="_deleteWidget" id="delete-btn" hidden="[[!display.isEditMode]]">DELETE</paper-button>
				<paper-button id="cancel" on-tap="hide">CANCEL</paper-button>
				<paper-button id="add" secondary on-tap="_saveWidget" disabled="[[!validateForm(config.*)]]">SAVE WIDGET</paper-button>
			</div>
		</paper-dialog>
	</template>
	<script>
		Polymer({
			is: "ui-add-widget-dialog",
			behaviors:[CommonBehavior.EVAjaxBehavior],
			validateForm: function() {
				return this.$.form.validate();
			},
			launch: function(config,elementList) {
				var types = Object.keys(_.groupBy(OEUtils.designerData.elementList, 'category'));
				this.set('display',{
					heading : (config.id === undefined ? "Add Widget" : "Edit Widget"),
					isEditMode : config.id !== undefined,
					widgetTypes:types
				})
				this.set('listComponent',elementList);
				this.set('config', config);
				this.$.dialog.open();
			},
			saveWidget: function() {
				this.fire('save-widget', this.config);
				this.hide();
			},
			hide: function() {
				this.$.dialog.close();
			},
			refreshElementList:function(){
				if(this.listComponent){
					this.listComponent.populateElementList();
				}
				this.hide();
			},
			_saveWidget: function() {
				var config = this.config;
				var method = config.id ? 'put' : 'post';
				delete config._userDefined;
				this.makeAjaxCall('/api/DesignerElements/', method, config, null, null, function(err, res) {
					if (!err) {
						this.fire('oe-show-success', 'Widget successfully added');
						this.refreshElementList();
					} else {
						this.resolveError(err);
					}
				}.bind(this))
			},
			_deleteWidget:function(){
				this.fire('oe-show-confirm', {
					message: 'Widget ' + this.config.name + ' will be permanently removed. Are you sure?',
					ok: function() {
						this.makeAjaxCall('/api/DesignerElements/' + this.config.id, 'delete', null, null, null, function(err, res) {
							if (!err) {
								this.fire('oe-show-success', 'Widget deleted successfully');
								this.refreshElementList();
							} else {
								this.resolveError(err);
							}
						}.bind(this));
					}.bind(this),
					cancel: null
				});
			}
		})

	</script>
</dom-module>
