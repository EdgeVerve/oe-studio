<link rel="import" href="oe-chart-attribute-editor.html">
<dom-module id="ui-custom-attribute-editor">
<template>
    <style></style>
    <iron-pages id="eleSelector" selected="[[elementSelected]]" attr-for-selected="ele-name">
        <oe-chart-attribute-editor ele-name="oe-charts"></oe-chart-attribute-editor>
    </iron-pages>
</template>
<script>
    Polymer({
        is:"ui-custom-attribute-editor",
        properties:{
            selectedElement: {
                type: Object,
                statePath: 'selectedElement'
            },
            selectedPolymerElement: {
                type: Object,
                statePath: 'selectedPolymerElement'
            }
        },
        observers:['_selectedElementChanged(selectedElement,selectedPolymerElement)'],
        behaviors: [
            ReduxBehavior
        ],
        actions: {
            update: function(element) {
                return {
                    type: 'UPDATE_ELEMENT',
                    element: element
                }
            }
        },
        listeners:{
            'update-attribute':'_updateAttribute',
            'delete-attribute':'_deleteAttribute'
        },
        _deleteAttribute:function(e){
            var attrObj = e.detail;
            this.selectedElement.removeAttribute(attrObj.attribKey);
            this.dispatch('update', this.selectedElement);
        },
        _updateAttribute:function(e){
            var attrObj = e.detail;
            if(attrObj.isBinded){
                this.selectedElement.setAttribute(attrObj.attribKey,"{{"+attrObj.bindValue+"}}");
            }else{
                switch(attrObj.type){
                    case "Boolean":
                        if(attrObj.value){
                            this.selectedElement.setAttribute(attrObj.attribKey,"");
                        }else{
                            this.selectedElement.removeAttribute(attrObj.attribKey);
                        }
                        break;
                    case "Object":
                    case "Array":
                        if(!attrObj.value){
                            this.selectedElement.removeAttribute(attrObj.attribKey);
                        }else{
                            this.selectedElement.setAttribute(attrObj.attribKey,JSON.stringify(attrObj.value));
                        }
                        break;
                    case "Number":
                    case "String":
                    default:
                        this.selectedElement.setAttribute(attrObj.attribKey,attrObj.value);
                        break;
                }
            }
            this.dispatch('update', this.selectedElement);
        },
        _selectedElementChanged:function(){
            if(this.selectedElement && this.selectedPolymerElement){
                var tagName = this.selectedElement.nodeName.toLowerCase();
                this.set('elementSelected',tagName);
                var selectedEditor =  this.$.eleSelector.selectedItem;
                if(!selectedEditor){
                    return;
                }
                var properties = this.selectedPolymerElement.properties;
                var config = {};
                if(properties){
                    Object.keys(properties).forEach(function(prop){
                        if(prop.startsWith('_')){
                            return;
                        }
                        var actualValue = this.selectedPolymerElement[prop];
                        var attrKey = OEUtils.camelToSnake(prop)
                        var attribValue = this.selectedElement.getAttribute(attrKey);
                        var hasAttribValue = !!attribValue && attribValue.length>0;
                        var obj = {
                            key:prop,
                            attribKey:attrKey,
                            label:OEUtils.camelCaseToLabel(prop),
                            type:properties[prop].type.name,
                            isBinded:(!!attribValue && attribValue.match(/(\{\{[0-9a-zA-Z\.]+\}\}|\[\[[0-9a-zA-Z\.]+\]\])$/))
                        }

                        if(obj.type === "Boolean"){
                            hasAttribValue = this.selectedElement.hasAttribute(attrKey);
                        }
                        obj.value = hasAttribValue?actualValue:null;
                        obj.bindValue = obj.isBinded? attribValue.substr(2,attribValue.length-4):"";
                        
                        config[prop] = obj;       
                    }.bind(this));
                    selectedEditor.set('elementConfig',config);
                }
            }
        }
    })
    </script>
</dom-module>