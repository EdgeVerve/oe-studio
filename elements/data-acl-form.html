<dom-module id="data-acl-form">
  <style>
    :host {
      padding: 16px;
      display: block;
    }

    .segment {
      display: block;
      margin-bottom: 8px;
    }

    .segment-header {
      font-size: 16px;
      font-weight: bold;
      font-family: Roboto-Light;
      letter-spacing: 0.7px;
      display: block;
      border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }

    .segment-controls-panel {
      margin-top: 8px;
      padding-left: 16px;
    }

    .segment-block {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .segment-block > *:not(iron-icon) {
      width: 45%;
      box-sizing: border-box;
    }

    .segment-input-helper {
      padding: 8px;
      background: #eee;
      border-radius: 4px;
    }

    .segment-input-helper > label {
      font-size: 12px;
      letter-spacing: 0.5px;
      font-family: Roboto-Light;
    }

    .segment-input-helper > label ol {
      margin: 0;
    }

    .segment-block > iron-icon {

      --iron-icon-width: 20px;
      --iron-icon-height: 20px;
      margin: 0 16px;
    }
  </style>
  <template>
    <div class="layout vertical">
      <div class="segment">
        <label class="segment-header">Model Access Control</label>
        <div class="segment-controls-panel">
          <div class="segment-block">
            <ev-combo field-id="accessType" label="Access Type" value="{{vm.accessType}}" listdata='["*","WRITE","READ","EXECUTE"]'></ev-combo>
            <iron-icon icon="info-outline" on-tap="toggleInfoPanel"></iron-icon>
            <iron-collapse>
              <div class="segment-input-helper">
                <label>Access Type specifies the type of access of the operation for which the data ACL will be attached.</label>
              </div>
            </iron-collapse>
          </div>
          <div class="segment-block">
            <template restamp is="dom-if" if="[[isCustomFunc(vm.accessType)]]">
              <ev-input field-id="property" label="Property" value="{{vm.property}}"></ev-input>
            </template>
            <template restamp is="dom-if" if="[[!isCustomFunc(vm.accessType)]]">
              <ev-combo field-id="property" label="Property" value="{{vm.property}}" listdata='[[_computePropertyList(vm.accessType)]]'></ev-combo>
            </template>
            <iron-icon icon="info-outline" on-tap="toggleInfoPanel"></iron-icon>
            <iron-collapse>
              <div class="segment-input-helper">
                <label>Model's Method Name (create,update,etc.) based on the selected accessType. Use * or blank for all properties.</label>
              </div>
            </iron-collapse>
          </div>
        </div>
      </div>
      <div class="segment">
        <label class="segment-header">User Authentication Control</label>
        <div class="segment-controls-panel">
          <div class="segment-block">
            <ev-combo required field-id="principalType" label="Principal Type" value="{{vm.principalType}}" listdata='["ROLE","USER"]'></ev-combo>
            <iron-icon icon="info-outline" on-tap="toggleInfoPanel"></iron-icon>
            <iron-collapse>
              <div class="segment-input-helper">
                <label>Principal Type specifies the type of user restriction for the current DataACL.</label>
              </div>
            </iron-collapse>
          </div>
          <div class="segment-block">
            <ev-combo required field-id="principalId" displayproperty="disp" valueproperty="value" listdata='[[_computePrincipalList(vm.principalType)]]'
              label="Principal Id" value="{{vm.principalId}}"></ev-combo>
            <iron-icon icon="info-outline" on-tap="toggleInfoPanel"></iron-icon>
            <iron-collapse>
              <div class="segment-input-helper">
                <label>Principal identifier (Based on principalType).The value must be one of:
									<ol>
										<li>A user ID</li>
										<li>One of the predefined dynamic loopback roles like $everyone, $owner etc. </li>
										<li>A static role name.</li>
									</ol>
								</label>
              </div>
            </iron-collapse>
          </div>
        </div>
      </div>
      <div class="segment">
        <label class="segment-header">Data ACL Control</label>
        <div class="segment-controls-panel">
          <div class="segment-block">
            <ev-json-input required field-id="filter" label="Filter" value="{{vm.filter}}"></ev-json-input>
            <iron-icon icon="info-outline" on-tap="toggleInfoPanel"></iron-icon>
            <iron-collapse>
              <div class="segment-input-helper">
                <label>Filter is the loopback filter object, determines which data can be accessed by user.</label>
              </div>
            </iron-collapse>
          </div>
          <div class="segment-block">
            <ev-input field-id="group" label="Group" value="{{vm.group}}"></ev-input>
            <iron-icon icon="info-outline" on-tap="toggleInfoPanel"></iron-icon>
            <iron-collapse>
              <div class="segment-input-helper">
                <label>Multiple Data ACLs within the same group are always 'or' condition.
									<br/> All Data ACLs with no group value are treated as a single same group.</label>
              </div>
            </iron-collapse>
          </div>
          <div class="segment-block">
            <ev-input field-id="errorCode" label="Error Code" value="{{vm.errorCode}}"></ev-input>
            <iron-icon icon="info-outline" on-tap="toggleInfoPanel"></iron-icon>
            <iron-collapse>
              <div class="segment-input-helper">
                <label>Error code to be used for data access error.</label>
              </div>
            </iron-collapse>
          </div>
          <div class="segment-block">
            <ev-json-input field-id="scope" label="Scope" value="{{vm.scope}}"></ev-json-input>
            <iron-icon icon="info-outline" on-tap="toggleInfoPanel"></iron-icon>
            <iron-collapse>
              <div class="segment-input-helper">
                <label>Manual scope to personalize the DataACL.</label>
              </div>
            </iron-collapse>
          </div>
        </div>
      </div>
    </div>
    <div class="layout horizontal center justified">
      <paper-button raised primary on-tap="doSave">Save</paper-button>
      <paper-button raised on-tap="doClear">Clear</paper-button>
    </div>
  </template>
  <script>
    Polymer({
      is: 'data-acl-form',
      properties: {
        vm: {
          type: Object
        },
        resturl: {
          type: String,
          value: 'api/DataACLs'
        }
      },
      attached: function () {
        this.use('preInsert', function (headers, model, cb) {
          model.model = this.modelNameToSave;
          if (!model.scope || Object.keys(model.scope).length == 0) {
            delete model.scope;
          }
          cb();
        }.bind(this));
        this.use('preUpdate', function (headers, model, cb) {
          if (!model.scope || Object.keys(model.scope).length == 0) {
            delete model.scope;
          }
          cb();
        }.bind(this));
        var readProperty = ['exists', 'find', 'findById', 'findOne', 'count'];
        var writeProperty = ['create', 'upsert', 'destroyById'];
        this.set('propertyLists', {
          write: writeProperty,
          read: readProperty,
          '*': writeProperty.concat(readProperty)
        });
        this.set('principalList', {});
      },
      isCustomFunc: function (type) {
        return type === 'EXECUTE'
      },
      _computePropertyList: function (type) {
        if (!type) {
          return;
        }
        return this.propertyLists[type.toLowerCase()]
      },
      _computePrincipalList: function (type) {
        if (!type) {
          return;
        }
        return this.principalList[type.toLowerCase()]
      },
      toggleInfoPanel: function (e) {
        e.currentTarget.nextElementSibling.toggle();
      },
      behaviors: [EV.FormValidationBehavior, EV.ModelHandler]
    })
  </script>
</dom-module>