<!-- Â©2015-2016 EdgeVerve Systems Limited (a fully owned Infosys subsidiary), Bangalore, India. All Rights Reserved.
The EdgeVerve proprietary software program ("Program"), is protected by copyrights laws, international treaties and other pending or existing intellectual property rights in India, the United States and other countries.
The Program may contain/reference third party or open source components, the rights to which continue to 
remain with the applicable third party licensors or the open source community as the case may be and nothing here transfers the rights to the third party and open source components, except as expressly permitted. 
Any unauthorized reproduction, storage, transmission in any form or by any means (including without limitation to electronic, mechanical, printing, photocopying, recording or  otherwise), or any distribution of this Program,or any portion of it, may result in severe civil and criminal penalties, and will be prosecuted to the maximum extent possible under the law. -->
<link rel="import" href="../behaviours/designer-dnd-behavior.html">
<link rel="import" href="../behaviours/designer-tab-behaviours.html">
<link rel="import" href="../../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../model-redux-store.html">
<dom-module id="model-work-area">
  <style>
     :host {
      display: block;
      --dark-border-color: 1px solid rgba(0, 0, 0, 0.22);
    }

    .jtk-endpoint {
      transition: transform 400ms ease;
      transform: scale(0)
    }

     :host.show-end-points .jtk-endpoint {
      transform: scale(1)
    }

    .side-nav {
      width: 215px;
      height: calc(100% - 100px);
      border-right: 1px solid var(--divider-color);
    }

    ul,
    li {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    /*workarea container styles*/

    .workarea-container {
      padding: 16px;
      box-sizing: border-box;
      position: absolute;
      height: 100%;
      width: calc(100vw - 320px);
      font-size: 12px;
      transform-origin: 50% 50%;
      transition: 0.1s all ease-out;
      cursor: -webkit-grab;
      left: 50px;
      transform-origin: top left;
    }

    .wrapper {
      position: relative;
      height: calc(100vh - 86px);
      overflow: auto;
    }

    .wrapper.show-grid {
      background: url('../images/grid.png');
    }

    .work-area {
      height: calc(100vh - 40px);
      padding: 8px;
      box-sizing: border-box;
      background: #dadada;
      width: 100%;
      position: relative;
      overflow: auto;
    }

    .work-area .wrapper-container {
      background: #ffffff;
      width: 100%;
    }

    .busy-text {
      font-size: 32px;
      padding: 32px;
    }

    #busy-spinner {
      --paper-spinner-stroke-width: 1px;
      transform: scale(2);
    }
    /* Tab styling */

    .tab-name.data-manager {
      color: #db8800;
    }

    .tab-name.model-detail {
      color: #00b0Bf;
    }

    .tab-name iron-icon.dirty-flag {
      height: 6px;
      width: 6px;
      padding: 2px;
      position: absolute;
      right: 0;
      top: 0;
      transition: opacity 300ms ease-in;
    }

    .dirty-flag.dirty-flag-true {
      opacity: 1;
    }

    .dirty-flag.dirty-flag-false {
      opacity: 0;
    }

    .tab-name div {
      overflow: hidden;
      font-size: 14px;
    }

    .tab-name span {
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      max-width: 90px;
    }

    .tab-name iron-icon+div+span {
      margin-left: 5px;
    }

    .tab-name iron-icon:not(.dirty-flag) {

      --iron-icon-height: 16px;
      --iron-icon-width: 16px;
      border-radius: 50%;
    }

    .add-empty-tab {
      color: #fff;
      background: #8e8e8e;
      margin: 0;
      height: 20px;
    }

    .add-empty-tab iron-icon {

      --iron-icon-height: 16px;
      --iron-icon-width: 16px;
    }

    .add-empty-tab.fixed-btn {
      position: absolute;
      top: 5px;
      right: -35px;
    }

    model-sidebar {
      height: calc(100vh - 40px);
    }

    .custom-menu ul {
      padding: 8px 0;
      margin: 0;
    }

    .custom-menu paper-button {
      padding: 0 12px !important;
      height: 35px !important;
    }

    .custom-menu .dropdown-content {
      background: #fff;
      color: #727272;
      cursor: pointer;
    }

    .custom-menu ul li {
      padding: 0 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-width: 100px;
      height: 32px;
      box-sizing: border-box;
      font-size: 14px;
      cursor: pointer;
    }

    .custom-menu li.drop-down-list-item:hover {
      background: #eee;
    }

    .tab-header {
      overflow: hidden;
    }

    .tabs-container {
      position: relative;
      width: calc(100% - 45px);
    }

    .tab-scroll-btn {
      height: 36px;
      background: #efefef;
      z-index: 1;
    }

    .tab-scroll-btn.right {
      box-shadow: -2px -1px 2px rgba(0, 0, 0, 0.25);
    }

    .tab-scroll-btn.left {
      box-shadow: 2px -1px 2px rgba(0, 0, 0, 0.25);
    }

    .tab-scroll-btn.hide-btn {
      display: none;
    }
    /* tab action buttons styles */

    .tab-buttons {
      position: absolute;
      bottom: 30px;
      right: 30px;
      display: flex;
      flex-direction: row;
      width: auto;
      align-items: center;
    }

    .save-btns {
      position: absolute;
      right: 80px;
      width: 270px;
      border: 1px solid var(--divider-color);
      display: flex;
      bottom: 10px;
      background: #F1F1F1;
    }

    paper-button iron-icon+span {
      margin-left: 8px;
    }

    .zoom-btns-container {
      left: 30px;
      padding: 2px;
      bottom: 30px;
      background: #F1F1F1;
      position: absolute;
      width: 30px;
      border: 1px solid var(--divider-color);
    }

    .zoom-btns-container paper-icon-button {
      width: 30px;
      height: 30px;
      padding: 3px;
    }

    .zoom-btns-container paper-icon-button+paper-icon-button {
      border-top: 1px solid var(--divider-color);
    }

    .tab-buttons>* {
      margin: 0 8px;
    }

    .empty-state {
      height: 100%;
      text-align: center;
    }

    .empty-state .main-label {
      font-size: 24px;
      font-family: 'Roboto-Light';
    }

    .empty-state .sub-label {
      font-size: 12px;
      margin-top: 8px;
    }

    .empty-state-icon {
      height: 40px;
      width: 40px;
    }
  </style>
  <template>
    <div class="flex horizontal layout">
      <iron-collapse id="expandBar" horizontal opened>
        <model-sidebar id="model-side-nav" show-models={{showModels}} show-views={{showViews}} view-list="{{viewList}}" on-render-view="_renderView"></model-sidebar>
      </iron-collapse>
      <div class="work-area">
        <div class="tab-header">
          <div class="tabs-container layout horizontal center">
            <paper-icon-button icon="chevron-left" class$="tab-scroll-btn left {{computeClass(hideScrollButtons)}}" disabled$="{{disableBtn(_leftHidden)}}"
              on-tap="_scrollToLeft"></paper-icon-button>
            <div class="tab-lister layout horizontal center" id="tabsContainer">
              <template is="dom-repeat" items="{{_tabList}}" as="tab">
                <div class$="tab-name layout horizontal justified center trapezoid tab-active-[[_isSelectedTab(index,_activeTabIndex)]] [[tab.type]]"
                  on-tap="_switchTab">
                  <div class="layout horizontal center">
                    <iron-icon icon="oe-designer-icons:data-manager" hidden$="{{showTabIcon(tab.type,'data-manager')}}"></iron-icon>
                    <iron-icon icon="oe-designer-icons:data-manager" hidden$="{{showTabIcon(tab.type,'view')}}"></iron-icon>
                    <iron-icon icon="oe-designer-icons:detailed-view" hidden$="{{showTabIcon(tab.type,'model-detail')}}"></iron-icon>
                    <div hidden="[[!_isDirtyTab(index,workSpaceModelCount)]]">*</div>
                    <span title$="[[_getTabName(index,_selectedTab.name)]]">[[_getTabName(index,_selectedTab.name)]]</span>
                  </div>
                  <iron-icon id="close-tab-icon" class="tab-close" icon="close" on-tap="_removeTab"></iron-icon>
                </div>
              </template>
            </div>
            <div class="add-empty-tab slanted-rombus layout horizontal center" id="addEmptyTab">
              <iron-icon icon="add" type="model-definition" on-tap="_addEmptyTab"></iron-icon>
            </div>
            <paper-icon-button icon="chevron-right" class$="tab-scroll-btn right {{computeClass(hideScrollButtons)}}" disabled$="{{disableBtn(_rightHidden)}}"
              on-tap="_scrollToRight"></paper-icon-button>
          </div>
        </div>
        <div class="wrapper-container">
          <div class="wrapper noselect" id="wrapperBg" hidden$="[[!modelDefinition]]">
            <div class="workarea-container" id="workarea" hidden$="[[_isEmpty(workSpaceModelCount)]]">
            </div>
            <template is="dom-if" if="[[_isEmpty(workSpaceModelCount)]]">
              <div class="empty-state layout vertical center-center">
                <iron-icon icon="oe-designer-icons:model" class="empty-state-icon"></iron-icon>
                <div class="main-label">Manage your Models</div>
                <div class="sub-label">Start creating new models or
                  <br>select a model from the left panel to manage your data</div>
              </div>
            </template>
          </div>
          <div hidden$="[[!dataManager]]">
            <data-manager model-list="[[modelList]]" id="model-work-area-data-manager"></data-manager>
          </div>
          <div hidden$="[[!listView]]">
            <model-detail id="model-detail"></model-detail>
          </div>
        </div>
        <div class="zoom-btns-container" hidden$="[[_isEmpty(workSpaceModelCount)]]">
          <div hidden$="[[_isEmpty(workSpaceModelCount)]]">
            <paper-icon-button icon="icons:zoom-in" id="zoom-in" on-tap="zoomIn"></paper-icon-button>
            <paper-icon-button icon="icons:zoom-out" id="zoom-out" on-tap="zoomOut"></paper-icon-button>
            <paper-tooltip for="zoom-in" position="right" animation-delay="0">Zoom in</paper-tooltip>
            <paper-tooltip for="zoom-out" position="right" animation-delay="0">Zoom Out</paper-tooltip>
          </div>
        </div>
        <div class="tab-buttons" hidden$="{{!showButtons}}">
          <div class="save-btns" hidden$="[[_isEmpty(workSpaceModelCount)]]">
            <paper-button secondary id="save-as-view-btn" on-tap="_addView">
              <iron-icon icon="icons:save"></iron-icon><span>SAVE VIEW</span>
            </paper-button>
            <paper-button secondary id="save-all-models-btn" on-tap="_saveModels">
              <iron-icon icon="icons:save"></iron-icon><span>SAVE ALL</span>
            </paper-button>
          </div>
          <work-area-menu id="model-menu" view-type="basic" model-list="{{modelList}}"></work-area-menu>
        </div>
      </div>
    </div>
    <model-definition-dialog id="createmodeldialog" model-list="{{modelList}}"></model-definition-dialog>
    <add-rule-dialog id="addRuleDlg"></add-rule-dialog>
    <attach-workflow-dialog id="attachWorkflowDlg"></attach-workflow-dialog>
    <manage-startup-data-dialog id="manageDataDialog"></manage-startup-data-dialog>
    <model-data-dialog id="modelDataDialog"></model-data-dialog>
    <add-relation-dialog id="addRelation"></add-relation-dialog>
    <property-dialog id="addProperty"></property-dialog>
    <add-view-dialog id="addView"></add-view-dialog>
    <model-detail-dialog id="detailDialog"></model-detail-dialog>
    <rule-mapper-dialog id="ruleMapperDialog"></rule-mapper-dialog>
    <data-acl-dialog id="dataAclDialog"></data-acl-dialog>
    <dynamic-acl-dialog id="dynamicAclDialog"></dynamic-acl-dialog>
  </template>
  <script>
    Polymer({
      'is': 'model-work-area',
      properties: {
        modelList: {
          type: Array,
          statePath: 'modelList'
        },
        viewList: {
          type: Array,
          notify: true,
          value: function () {
            return [];
          }
        },
        dataManager: {
          type: Boolean,
          value: false
        },
        listView: {
          type: Boolean,
          value: false
        },
        modelDefinition: {
          type: Boolean,
          value: true
        },
        selectedRelation: {
          type: Object,
          value: function () {
            return {
              type: '',
              icon: ''
            }
          }
        },
        relationTypes: {
          type: Array,
          value: [{
            type: 'hasMany',
            icon: 'oe-icons:has-many'
          }, {
            type: 'belongsTo',
            icon: 'oe-icons:belongs-to'
          }, {
            type: 'hasOne',
            icon: 'oe-icons:has-one'
          }]
        },
        showButtons: true,
        removeModel: false,
        newConnection: Boolean,
        relationName: String,
        workAreaInstance: Object,
        currentConnection: Object,
        workSpaceModelList: Array
      },
      listeners: {
        'delete-model': '_confirmDelete',
        'create-model': '_addModel',
        'create-relation': '_setRelation',
        'save-view': '_saveView',
        'view-model-detail': '_openDetailDialog',
        'render-model': '_renderModel',
        'tab-selected': '_renderTab',
        'close-model-container': 'closeModel',
        'iron-resize': '_onTabsChanged',
        'edit-rule': '_editRule',
        'add-rule': '_addRule',
        'manage-startup-data': '_manageStartupData',
        'attach-model-rule': '_attachModelRule',
        'attach-data-acl': '_attachDataAcl',
        'attach-dynamic-acl': '_attachDynamicAcl',
        'attach-workflow': '_attachWorkflow'
      },
      observers: [
        '_viewChanged(_selectedTab.currentZoom, currentX, currentY)',
        'tabsChanged(_tabList.splices)'
      ],
      tabsChanged: function (changeRecord) {
        if (changeRecord) {
          this.fire('iron-resize');
        }
      },
      behaviors: [
        CommonBehavior.EVAjaxBehavior,
        CommonBehavior.ModelBehavior,
        TabBehavior.TabBehavior,
        DesignerBehavior.ResizableBehavior,
        ModelReduxBehavior
      ],
      actions: {
        deleteModel: function (index) {
          return {
            type: "DELETE_MODEL",
            index: index
          }
        },
        updateModelList: function (modelObj, index) {
          return {
            type: 'UPDATE_MODEL_LIST',
            index: index,
            modelObj: modelObj
          }
        }
      },
      _isEmpty: function (state) {
        var isEmpty = false;
        switch (typeof state) {
          case 'boolean':
            isEmpty = state;
            break;
          case 'string':
            isEmpty = state.trim().length == 0;
            break;
          case 'number':
            isEmpty = state == 0;
            break;
          case 'object':
            if (Array.isArray(state)) {
              isEmpty = state.length == 0;
            } else {
              isEmpty = Object.keys(state).length;
            }
            break;
          default:
            break;
        }
        return isEmpty;
      },
      attached: function () {
        this.hideScrollButtons = true;
        this._rightHidden = true;
        this._leftHidden = true;
        this.selectedView = null;
        this.set('workSpaceModelCount', 0);
        this.set('showGridBg', false);
        document.addEventListener('toggle-bg', function (e) {
          this.showGridBg = e.detail;
          if (this.showGridBg) {
            this.$.wrapperBg.classList.add('show-grid')
          } else {
            this.$.wrapperBg.classList.remove('show-grid')
          }
        }.bind(this));
        document.addEventListener('toggle-grid-sidemenu', function (e) {
          if (e.detail) {
            this.$.expandBar.opened = false;
          } else {
            this.$.expandBar.opened = true;
          }
        }.bind(this));
        document.addEventListener('add-view', function () {
          var view = {
            name: this._selectedTab.name,
            models: this.getWorkSpaceContainers()
          }

          if (this._selectedTab.view && this._selectedTab.view.name == this._selectedTab.name) {
            this._selectedTab.view.models = view.models;
            this.makeAjaxCall('/api/ModelViews', 'PUT', this._selectedTab.view, null, null,
              function (err, response) {
                if (response) {
                  var index = _.findIndex(this.viewList, {
                    'name': response.name
                  })
                  if (index == -1) {
                    this.push('viewList', response);
                  } else {
                    this.set('viewList.' + index, response)
                  }
                }
                if (err) {
                  this.fire('oe-show-error', 'Error saving view')
                }
              }.bind(this))
          } else {
            this.$.addView.set('view', view);
            this.$.addView.openDialog();
          }
        }.bind(this));
      },
      _attachModelRule: function (e) {
        this.$.ruleMapperDialog.openDialog(e.detail);
      },
      _attachDataAcl: function (e) {
        this.$.dataAclDialog.openDialog(e.detail);
      },
      _attachDynamicAcl: function (e) {
        this.$.dynamicAclDialog.openDialog(e.detail);
      },

      /* =========TAB OPERATIONS START========== */
      _addEmptyTab: function () {
        if (this.untitledTab) {
          this.untitledTab++
        }
        var tab = {
          name: 'untitled_view_' + this.untitledTab,
          type: 'view',
          models: [],
          view: {},
          currentZoom: 1
        }

        if (this._selectedTab) {
          this._selectedTab.models = this.getWorkSpaceContainers();
        }
        this._openTab(tab);
      },
      showTabIcon: function (tabType, type) {
        return tabType !== type;
      },
      _switchTab: function (e) {
        var index = e.model.index;
        if (index > (this._tabList.length - 1)) {
          return;
        }
        if (this._selectedTab.type === 'view') {
          this._selectedTab.models = this.getWorkSpaceContainers();
        }
        this.set('showButtons', false);
        this._selectTab(index);
      },
      _removeTab: function (e) {
        this._switchTab(e);
        var type = e.model.tab.type;
        if (type != 'view') {
          var index = _.findIndex(this._tabList, function (d) {
            if (d.model && e.model.tab.model) {
              return d.model.name === e.model.tab.model.name;
            } else if (d.name && e.model.tab.name) {
              return d.name === e.model.tab.name;
            } else {
              return;
            }
          });
          this._closeTab(index);
          return;
        }
        var self = this;
        if (this._tabList.length == 1) {
          this.fire('oe-show-error', 'Cannot close all tabs');
          return;
        }
        var hasView = this._selectedTab.view && this._selectedTab.view.name;
        var modelNodes = this.getWorkSpaceModels();
        var isDirty = hasView ? this.isWorkspaceDirty() : (modelNodes.length > 0);
        if (isDirty) {
          var decisionText = hasView ? 'Save changes to View ?' : 'Save as a new View ?';

          var data = {
            message: decisionText,
            ok: function () {
              self.fire('add-view');
              self.clearWorkSpace();
              self._closeTab(self._activeTabIndex);
            }.bind(this),
            cancel: function () {
              self.clearWorkSpace();
              self._closeTab(self._activeTabIndex);
            }
          }
          this.fire('oe-show-confirm', data);
        } else {
          if (hasView) {
            self.fire('add-view');
          }
          self.clearWorkSpace();
          self._closeTab(self._activeTabIndex);
        }
      },
      _renderTab: function (e) {
        var detail = e.detail
        var model = detail.model || this._selectedTab.model;
        var subType = detail.subType || 'model';
        if (this._selectedTab.model && this._selectedTab.model.name !== model.name) {
          this.set('_selectedTab.model', model);
          this.set('_selectedTab.name', model.name + '-' + this._selectedTab.type);
        }
        //unload all models
        this.clearWorkSpace();
        var sideNav = this.$['model-side-nav'];
        this.set('showButtons', true);
        //render data-manager tab
        if (this._selectedTab && this._selectedTab.type === 'data-manager') {
          this.set('listView', false);
          this.set('modelDefinition', false);
          this.set('dataManager', true);
          var dataManager = this.querySelector('#model-work-area-data-manager');
          dataManager._showData(model);
          this.set('showButtons', false);
        } else if (this._selectedTab && this._selectedTab.type === 'model-detail') {
          this.set('dataManager', false);
          this.set('modelDefinition', false);
          this.set('listView', true);
          var modelListView = this.querySelector('#model-detail');
          modelListView.set('selectedPage', 0);
          var modelSideNav = this.querySelector('#model-side-nav');
          modelSideNav.showSelectedModel(model, subType);
          //modelListView.set('modelList', this.modelList);
          this.set('showButtons', false);
        }
        //load tab models
        else if (this._selectedTab && this._selectedTab.models && Array.isArray(this._selectedTab.models)) {
          this.set('dataManager', false);
          this.set('listView', false);
          this.set('modelDefinition', true);
          this._selectedTab.models.forEach(function (modelConfig) {
            var index = _.findIndex(sideNav.modelList, {
              'id': modelConfig.id
            });
            if(index === -1){
              return;
            }
            sideNav.set('modelList.' + index + '.checked', true);
            sideNav.fire('render-model', sideNav.modelList[index]);
          });
        }
      },
      _getTabName: function (index) {
        var tab = this._tabList[index];

        if (!tab) {
          return;
        }

        return tab.model ? tab.model.name : tab.name;
      },
      _onTabsChanged: function () {
        this.debounce('_onTabsChanged', function () {
          this._affectScroll(0);
        }, 10);
      },
      get _tabContainerScrollSize() {
        return Math.max(
          0,
          this.$.tabsContainer.scrollWidth -
          this.$.tabsContainer.offsetWidth
        );
      },
      computeClass: function (hideScrollButtons) {
        return hideScrollButtons ? 'hide-btn' : '';
      },
      disableBtn: function (hideBtn) {
        return hideBtn;
      },
      _affectScroll: function (dx) {
        this.$.tabsContainer.scrollLeft += dx;
        var scrollLeft = this.$.tabsContainer.scrollLeft;
        var addBtn = this.$.addEmptyTab;
        if (this._tabContainerScrollSize > 0) {
          this.set('hideScrollButtons', false);
          addBtn.classList.add('fixed-btn');
        } else {
          this.set('hideScrollButtons', true);
          addBtn.classList.remove('fixed-btn');
        }
        this.set('_leftHidden', scrollLeft === 0);
        this.set('_rightHidden', scrollLeft === this._tabContainerScrollSize);
      },
      _scrollToLeft: function () {
        this._affectScroll(-125);
      },
      _scrollToRight: function () {
        this._affectScroll(125);
      },
      _isDirtyTab: function (index) {
        var tab = this._tabList[index];
        if (!tab || tab.type != 'view') {
          return false;
        }

        if (tab.view && tab.view.models) {
          if (this._activeTabIndex == index) {
            return !_.isEqual(tab.view.models, this.getWorkSpaceContainers())
          } else {
            return !_.isEqual(tab.models, tab.view.models)
          }
        }
        return false;
      },

      /*=========TAB OPERATIONS END==========*/


      /*=========VIEW OPERATIONS START==========*/
      _addView: function () {
        var view = {
          name: this._selectedTab.name,
          models: this.getWorkSpaceContainers()
        }

        if (this._selectedTab.view && this._selectedTab.view.name == this._selectedTab.name) {
          this._selectedTab.view.models = view.models;
          this.fire('save-view', this._selectedTab.view);
        } else {
          this.$.addView.set('view', view);
          this.$.addView.openDialog();
        }
      },
      _saveView: function (event) {
        var view = event.detail;
        this.makeAjaxCall('/api/ModelViews', 'PUT', view, null, null, function (err, response) {
          if (response) {
            var index = _.findIndex(this.viewList, {
              'name': response.name
            })
            if (index == -1) {
              this.push('viewList', response);
            } else {
              this.set('viewList.' + index, response)
            }
            this.set('_tabList.' + this._activeTabIndex + '.name', response.name);
            this.set('_selectedTab.name', response.name);
            this.set('_selectedTab.models', response.models);
            this.set('_selectedTab.view', response);
            this.fire('oe-show-success', 'View saved successfully');
          }
          if (err) {
            this.fire('oe-show-error', 'Error saving view')
          }
        }.bind(this))
      },
      _renderView: function (e) {
        var currView = e.detail;
        var tab = {
          name: currView.name,
          models: currView.models,
          view: currView,
          type: 'view'
        };

        if (this._selectedTab) {
          this._selectedTab.models = this.getWorkSpaceContainers();
        }

        var index = _.findIndex(this._tabList, function (t) {
          return t.name == tab.name
        });
        if (index != -1) {
          var difference = _.xor(tab.models, this._tabList[index].models);
          if (difference.length > 0) {
            var data = {
              message: 'Do you want to reload view models?',
              ok: function () {
                this._tabList[index].models = tab.models;
                this._tabList[index].view = tab.view;
                this._openTab(tab);
              }.bind(this),
              cancel: function () {
                tab = this._tabList[index];
                this._openTab(tab);
              }
            }
            this.fire('oe-show-confirm', data);
          } else {
            this._openTab(tab);
          }
        } else {
          this._openTab(tab);
        }
      },
      isWorkspaceDirty: function () {
        var workSpaceModels = this.getWorkSpaceModels('id');
        var viewModels = this._selectedTab.view.models.map(function (m) {
          return m.id
        });
        var difference = _.xor(workSpaceModels, viewModels);
        return (difference.length != 0);
      },

      /*=========VIEW OPERATIONS END==========*/


      /*=========COMMON OPERATIONS START==========*/
      getWorkSpaceModels: function (prop) {
        var modelNodes = this.$.workarea.querySelectorAll('model-container');
        var workSpaceModels = _.map(modelNodes, function (model) {
          if (prop) {
            return model.modelObj[prop]
          } else {
            return model.modelObj
          }
        });
        return workSpaceModels
      },
      getWorkSpaceContainers: function () {
        var modelNodes = this.$.workarea.querySelectorAll('model-container');
        var workSpaceModels = _.map(modelNodes, function (model) {
          return {
            id: model.modelObj.id,
            top: model.style.top,
            left: model.style.left
          }
        });
        return workSpaceModels
      },
      clearWorkSpace: function () {
        this.$['model-side-nav'].unselectAll();
        var modelNodes = this.$.workarea.querySelectorAll('model-container');
        [].forEach.call(modelNodes,function(node){
            this.workAreaInstance.remove(node);
        }.bind(this))
        this.set('workSpaceModelList', []);
        this.set('workSpaceModelCount', 0);
        Polymer.dom.flush();
      },
      closeModel: function (e) {
        var sideNav = this.$['model-side-nav'];
        var index = _.findIndex(sideNav.modelList, function (model) {
          return (model.name == e.detail.name);
        })
        if (index != -1) {
          sideNav.set('modelList.' + index + '.checked', false);
          sideNav.fire('render-model', sideNav.modelList[index]);
        }
      },

      /*=========COMMON OPERATIONS END==========*/

      _openDetailDialog: function (e) {
        var modelObj = e.detail;
        var baseModel = _.find(this.modelList, {
          name: modelObj.base
        });

        var baseProps = [];
        if (baseModel) {
          baseProps = baseModel.properties;
        }
        this.$.detailDialog.set('baseProperties', baseProps);
        this.$.detailDialog.modelObj = modelObj;
        this.$.detailDialog.openDialog();
      },
      _saveModels: function () {
        var self = this;
        var modelNodes = self.$.workarea.querySelectorAll('model-container');
        var tempArray = [];
        self.set('workSpaceModelList', []);
        [].forEach.call(modelNodes, function (item) {
          (function (item) {
            var modelObj = item.modelObj;
            var tempObj = JSON.parse(JSON.stringify(modelObj));
            tempObj = self.modelToObject(tempObj);
            delete tempObj.checked;
            var url = 'api/ModelDefinitions';
            var method = 'put';
            var body = tempObj;
            self.makeAjaxCall(url, method, body, null, null, function (err, response) {
              if (err) {
                tempArray.push({
                  modelName: tempObj.name,
                  status: 'failure'
                });
                //updating workspace models
                self.push('workSpaceModelList', modelObj);
                var fModels;
                var sModels;
                var message;
                if (modelNodes.length === tempArray.length) {
                  sModels = tempArray.filter(function (d) {
                    return d.status === 'success';
                  }).map(function (d) {
                    return d.modelName;
                  }).join(', ');

                  fModels = tempArray.filter(function (d) {
                    return d.status === 'failure';
                  }).map(function (d) {
                    return d.modelName;
                  }).join(', ');

                  message = fModels + ' failed to save. '
                  if (sModels.length) {
                    message += sModels + ' models saved successfully.';
                  }
                  self.fire('oe-show-error', message);
                }
              } else if (response) {
                tempObj = response;
                tempObj.checked = true;
                item.set('modelObj', OEUtils.clone(self.modelToArray(tempObj)));
                var updateModelIndex = self.modelList.findIndex(function (x) {
                  return x.id == tempObj.id;
                });
                //updating the main modelList
                response.checked = true;
                self.dispatch('updateModelList', tempObj, updateModelIndex);
                // self.set('modelList.' + updateModelIndex, OEUtils.clone(tempObj));
                //updating workspace models
                self.push('workSpaceModelList', OEUtils.clone(tempObj));
                tempArray.push({
                  modelName: tempObj.name,
                  status: 'success'
                });

                if (modelNodes.length === tempArray.length) {
                  sModels = tempArray.filter(function (d) {
                    return d.status === 'success';
                  }).map(function (d) {
                    return d.modelName;
                  }).join(', ');

                  fModels = tempArray.filter(function (d) {
                    return d.status === 'failure';
                  }).map(function (d) {
                    return d.modelName;
                  }).join(', ');

                  message = sModels + ' models saved successfully. ';
                  if (fModels.length) {
                    message += fModels + ' failed to save. ';
                    self.fire('oe-show-error', message);
                  } else {
                    self.fire('oe-show-success', message);
                  }
                }
              }
            });
          })(item);
        });
      },
      _renderModel: function (e) {
        var modelObj = e.detail;
        this.relationName = '';
        this.newConnection = true;
        this.removeModel = false;
        if (modelObj.checked) {
          this.createModelContainer(modelObj);
          this._showExistingRelations();
        } else {
          this.removeModel = true;
          var selectedIndex, selectedModelIndex = -1;
          var modelNodes = this.$.workarea.querySelectorAll('model-container');
          selectedIndex = [].findIndex.call(modelNodes, function (model) {
            return model.modelObj.id == modelObj.id
          });
          selectedModelIndex = this.workSpaceModelList.findIndex(function (x) {
            return x.id == modelObj.id;
          });
          //reverting back to the old state when it is removed from workarea
          var updateModelIndex = this.modelList.findIndex(function (x) {
            return x.id == modelObj.id;
          });
          this.workSpaceModelList[selectedModelIndex].checked = false;
          this.dispatch('updateModelList', this.workSpaceModelList[selectedModelIndex], updateModelIndex);
          // this.set('modelList.' + updateModelIndex, this.workSpaceModelList[selectedModelIndex]);
          //deleting from workarea
          this.workAreaInstance.remove(modelNodes[selectedIndex]);
          //deleting from workspace array
          this.splice('workSpaceModelList', selectedModelIndex, 1);
          this.removeModel = false;
          this.set('workSpaceModelCount', (this.getWorkSpaceContainers().length));
        }
      },
      _setRelation: function () {
        if (this.classList.contains('show-end-points')) {
          this.classList.remove('show-end-points');
        } else {
          this.classList.add('show-end-points');
        }
      },
      _confirmDelete: function (e) {
        var data = {
          message: 'Do you want to delete ?',
          ok: function () {
            this._deleteModel(e);
          }.bind(this),
          cancel: function () {
            return;
          }
        }
        this.fire('oe-show-confirm', data);
      },
      _deleteModel: function (event) {
        var modelObj = event.detail;
        var url = '/api/ModelDefinitions/' + modelObj.id + '/' + modelObj._version;
        var method = 'delete';
        this.makeAjaxCall(url, method, {}, null, null, function (err, response) {
          if (err) {
            this.resolveError(err);
          } else if (response) {
            this.fire('oe-show-success', 'Model deleted successfully');
            var modelNodes = this.$.workarea.querySelectorAll('model-container');
            var workareaIndex, workspaceIndex, updateModelIndex = -1;
            workareaIndex = [].findIndex.call(modelNodes, function (model) {
              return model.modelObj.id == modelObj.id
            });
            workspaceIndex = this.workSpaceModelList.findIndex(function (x) {
              return x.id == modelObj.id;
            });
            updateModelIndex = this.modelList.findIndex(function (x) {
              return x.id == modelObj.id;
            });
            //deleting from model list
            this.splice('modelList', updateModelIndex, 1);
            //deleting from workarea
            this.workAreaInstance.remove(modelNodes[workareaIndex]);
            //deleting from workspace array 
            this.splice('workSpaceModelList', workspaceIndex, 1);
          }
        }.bind(this));
      },
      _addModel: function (e) {
        this.$.createmodeldialog.openDialog();
        this.$.createmodeldialog.set('editModel', false);
        this.$.createmodeldialog.set('isEditMode', false);

        //Reset Validation in first page
        var form = this.$.createmodeldialog.$.basicform
        _.forEach(form.elements, function (ele) {
          ele.invalid = false
        });

        this.$.createmodeldialog.set('renderInWorkArea', e.detail.renderInWorkArea);
        this.$.createmodeldialog.set('vm', {
          name: '',
          plural: '',
          description: '',
          base: 'BaseEntity',
          idInjection: false,
          enableDefaultUI: false,
          strict: true,
          properties: [],
          validations: [],
          evValidations: [],
          relations: [],
          acls: [],
          methods: [],
          checked: false,
          dataSourceName: '',
          autoscope: []
        });
      },
      _showExistingRelations: _.debounce(function () {
        var self = this;
        var modelNodes = self.$.workarea.querySelectorAll('model-container');
        if (modelNodes.length > 1) {
          [].map.call(modelNodes, function (model) {

            var endPoint = model.getAttribute('id');
            var connections = self.workAreaInstance.getConnections()
            connections.forEach(function (c) {
              if (c.sourceId == endPoint) {
                self.removeModel = true;
                self.workAreaInstance.deleteConnection(c);
              }
            });

            if (model.modelObj.relations) {
              model.modelObj.relations.forEach(function (relation) {
                var targetModel = self._checkExisitingModel(relation.model);
                if (targetModel.found == true) {
                  self.relationName = relation.__name__;
                  self.selectedRelation.type = relation.type;
                  self.newConnection = false;
                  var sourceEndPoint = model.getAttribute('id') +
                    '-right';
                  var targetEndPoint = targetModel.model.getAttribute(
                    'id') + '-left';
                  self.workAreaInstance.connect({
                    uuids: [sourceEndPoint, targetEndPoint]
                  });
                }
              });
            }
          });
        }
        self.newConnection = true;
        self.selectedRelation = {
          type: '',
          icon: ''
        };
        self.set('workSpaceModelCount', (self.getWorkSpaceContainers().length));
      }, 1000),
      _checkExisitingModel: function (checkmodel) {
        var modelNodes = this.$.workarea.querySelectorAll('model-container');
        var targetModel = {
          found: false,
          model: {}
        };
        [].map.call(modelNodes, function (model) {
          if (model.modelObj.name == checkmodel) {
            targetModel.model = model;
            targetModel.found = true;
          }
        });
        return targetModel;
      },
      _setjsPlumbParams: function (ele) {
        this.workAreaInstance.draggable(ele);
        var e1 = this.workAreaInstance.addEndpoint(ele, {
          uuid: ele.getAttribute('id') + '-right',
          cssClass: 'model-work-area custom-end-point',
          endpoint: ['Image', {
            src: 'bower_components/oe-studio/images/start_point_arrows.svg'
          }],
          anchor: 'Right',
          isSource: true,
          deleteEndpointsOnDetach: false
        });
        e1.bind('mouseover', function (endpoint) {
          endpoint.canvas.setAttribute('title',
            'Use these dots to drag the relations to other models');
        });
        var e2 = this.workAreaInstance.addEndpoint(ele, {
          uuid: ele.getAttribute('id') + '-left',
          cssClass: 'model-work-area custom-end-point',
          endpoint: ['Image', {
            src: 'bower_components/oe-studio/images/end_point_arrows.svg'
          }],
          anchor: 'Left',
          isTarget: true,
          deleteEndpointsOnDetach: false
        });
        e2.bind('mouseover', function (endpoint) {
          endpoint.canvas.setAttribute('title',
            'Use these dots to drop the relations from other models');
        });
      },
      createModelContainer: function (obj) {
        var elem = document.createElement('model-container');
        elem.modelObj = obj;
        var modelNodes = this.$.workarea.querySelectorAll('model-container');

        var modelConfig = _.find(this._selectedTab.models, {
          id: obj.id
        });

        if (modelConfig) {
          elem.style.left = modelConfig.left;
          elem.style.top = modelConfig.top;
        } else {
          if (modelNodes.length > 0) {
            var lastNode = modelNodes[modelNodes.length - 1];
            var leftPos = lastNode.style.left.slice(0, lastNode.style.left.length - 2);
            var topPos = lastNode.style.top.slice(0, lastNode.style.top.length - 2);
            var newLeft = isNaN(leftPos) ? Math.round(Math.random() * 100) : (parseInt(leftPos) +
              250 + 30);
            if (modelNodes.length % 5 == 0) {
              elem.style.left = '0px';
              elem.style.top = (parseInt(topPos) + 350 + 30) + 'px';
            } else {
              elem.style.left = newLeft + 'px';
              elem.style.top = lastNode.style.top;
            }
          } else {
            elem.style.left = '0px';
            elem.style.top = '20px';
          }
        }
        this.push('workSpaceModelList', obj);
        this.set('workSpaceModelCount', this.workSpaceModelList.length);
        Polymer.dom.flush();
        this.$.workarea.appendChild(elem);
        this._setjsPlumbParams(elem);

      },
      _viewChanged: function () {
        var workarea = this.$.workarea;
        workarea.style.transform = 'scale(' + this._selectedTab.currentZoom + ')';
      },
      zoomIn: function () {
        if (this._selectedTab.currentZoom < 2) {
          var zoom = this._selectedTab.currentZoom + 0.1;
          this.set('_selectedTab.currentZoom', zoom);
        }
      },
      zoomOut: function () {
        if (this._selectedTab.currentZoom > 0.4) {
          var zoom = this._selectedTab.currentZoom - 0.1;
          this.set('_selectedTab.currentZoom', zoom);
        }
      },
      _editRule: function (e) {
        var editRuleDialog = this.$.addRuleDlg;
        editRuleDialog.set('selectedRule', e.detail.rule);
        editRuleDialog.set('modelObj', e.detail.modelObj);
        editRuleDialog.set('isEditMode', true);
        editRuleDialog.openDialog();
      },
      _addRule: function (e) {
        var editRuleDialog = this.$.addRuleDlg;
        editRuleDialog.set('modelObj', e.detail);
        editRuleDialog.set('isEditMode', false);
        editRuleDialog.openDialog();
      },
      _manageStartupData: function (e) {
        var dialog = this.$.manageDataDialog;
        dialog.set('modelName', e.detail);
        dialog.openDialog();
      },
      _attachWorkflow: function (e) {
        var attachWorkflowDlg = this.$.attachWorkflowDlg;
        attachWorkflowDlg.set('modelObj', e.detail);
        attachWorkflowDlg.openDialog();
      },
      ready: function () {
        var self = this;
        self.currentZoom = 1;
        self.currentX = 0;
        self.currentY = 0;

        //pan implementation
        var workarea = self.$.workarea;
        var workzone = workarea.parentElement;

        var mouseMoveEvent = function (ev) {
          self.set('currentX', self.currentX + ev.movementX);
          self.set('currentY', self.currentY + ev.movementY);
        }

        workzone.addEventListener('mousedown', function () {
          workzone.style.cursor = '-webkit-grabbing';
          workzone.onmousemove = mouseMoveEvent;
        });

        workzone.addEventListener('mouseup', function () {
          workzone.style.cursor = '-webkit-grab';
          workzone.onmousemove = null;
        });

        workzone.addEventListener('mouseout', function () {
          workzone.style.cursor = '-webkit-grab';
          workzone.onmousemove = null;
        });

        self.set('workSpaceModelList', []);
        jsPlumb.ready(function () {
          self.workAreaInstance = jsPlumb.getInstance();
          //set work area
          self.workAreaInstance.setContainer(self.$.workarea);
          self.workAreaInstance.importDefaults({
            Connector: 'Flowchart',
            Overlays: [
              ['Label', {
                location: 0.25
              }]
            ],
            ConnectionOverlays: [
              ['Arrow', {
                width: 8,
                length: 10,
                location: 0.95
              }]
            ],
            MaxConnections: 100000
          });
          self.workAreaInstance.connectorClass = 'model-work-area custom-connector';
          self.workAreaInstance.overlayClass = 'model-work-area overlay-label-style';

          //do actions needed before connection
          self.workAreaInstance.bind('beforeDrop', function (info) {
            //check for already existing relation
            var conn = self.workAreaInstance.select({
              source: info.sourceId,
              target: info.targetId
            });
            if (conn.length > 0) {
              self.fire('oe-show-error', 'There is already a relation');
              return false;
            }
            self.set('selectedRelation', {
              type: 'hasMany',
              icon: 'oe-icons:has-many'
            });
            return true;
          });

          self.workAreaInstance.bind('connection', function (info) {
            var connection = info.connection;
            connection.addOverlay(['Label', {
              label: self.relationName + '(' + self.selectedRelation
                .type + ')',
              id: 'label',
              location: 0.25
            }]);

            self.currentConnection = connection;
            if (self.newConnection) {
              self.$.addRelation.openDialog();
              self.$.addRelation.relationName = '';
              self.$.addRelation.source = info.source.modelObj;
              self.$.addRelation.target = info.target.modelObj;
              self.$.addRelation.set('relation', self.selectedRelation);
            }
          });
          self.addEventListener('add-relation', function (e) {
            self.relationName = e.detail.name;
            self.selectedRelation.type = e.detail.relation.type;
            var pascalToCamel = function (str) {
              return str[0].toLowerCase() + str.substr(1)
            }

            //adding relations in the source model
            var relationObj = {
              '__name__': self.relationName,
              type: self.selectedRelation.type,
              model: self.currentConnection.target.modelObj.name,
              foreignKey: pascalToCamel(self.currentConnection.source.modelObj.name) + "Id"
            };
            self.push('currentConnection.source.modelObj.relations',
              relationObj);
            self.classList.remove('show-end-points');
            //updating the label
            var label = self.currentConnection.getOverlay('label');
            label.setLabel(self.relationName + ' (' + self.selectedRelation.type + ')');
            self.selectedRelation = {
              type: '',
              icon: ''
            };
            self.relationName = '';
          });

          document.addEventListener('undo-relation', function () {
            self.removeModel = false;
            self.workAreaInstance.deleteConnection(self.currentConnection);
            self.selectedRelation = {
              type: '',
              icon: ''
            };
            self.relationName = '';
          });
          self.addEventListener('edit-model', function (e) {
            self.$.createmodeldialog.set('isEditMode', true);
            self.$.createmodeldialog.set('editModel', true);
            self.$.createmodeldialog.set('vm', JSON.parse(JSON.stringify(e.detail)));
            self.$.createmodeldialog._setFlags(1);
            self.$.createmodeldialog.openDialog();
          });
          self.addEventListener('add-property-in-dialog', function (e) {
            self.$.createmodeldialog.set('isEditMode', true);
            self.$.createmodeldialog.set('editModel', true);
            self.$.createmodeldialog.set('vm', JSON.parse(JSON.stringify(e.detail)));
            self.$.createmodeldialog.openDialog();
            self.$.createmodeldialog.selected = 1;
            self.$.createmodeldialog._validateTab();
            self.$.createmodeldialog.$.propertyGrid._addProperty();
          });
          self.addEventListener('add-validation-in-dialog', function (e) {
            self.$.createmodeldialog.set('isEditMode', true);
            self.$.createmodeldialog.set('editModel', true);
            self.$.createmodeldialog.set('vm', JSON.parse(JSON.stringify(e.detail)));
            self.$.createmodeldialog.openDialog();
            self.$.createmodeldialog.selected = 2;
            self.$.createmodeldialog._validateTab();
            self.$.createmodeldialog.$.propertyGrid._addValidation();
          });
          self.addEventListener('add-relation-in-dialog', function (e) {
            self.$.createmodeldialog.set('isEditMode', true);
            self.$.createmodeldialog.set('editModel', true);
            self.$.createmodeldialog.set('vm', JSON.parse(JSON.stringify(e.detail)));
            self.$.createmodeldialog.openDialog();
            self.$.createmodeldialog.selected = 3;
            self.$.createmodeldialog._validateTab();
            self.$.createmodeldialog.$.relationGrid._addRelation();
          });
          self.addEventListener('add-acl-in-dialog', function (e) {
            self.$.createmodeldialog.set('isEditMode', true);
            self.$.createmodeldialog.set('editModel', true);
            self.$.createmodeldialog.set('vm', JSON.parse(JSON.stringify(e.detail)));
            self.$.createmodeldialog.openDialog();
            self.$.createmodeldialog.selected = 4;
            self.$.createmodeldialog._validateTab();
            self.$.createmodeldialog.$.aclGrid._addacl();
          });
          self.addEventListener('clone-model', function (e) {
            self.$.createmodeldialog.set('isEditMode', false);
            self.$.createmodeldialog.set('editModel', false);
            self.$.createmodeldialog.set('renderInWorkArea', true);
            var modelObj = JSON.parse(JSON.stringify(e.detail));
            modelObj.name = 'CopyOf' + modelObj.name;
            delete modelObj.id;
            delete modelObj._version;
            delete modelObj._createdBy;
            delete modelObj._createdOn;
            delete modelObj._modifiedBy;
            delete modelObj._modifiedOn;
            delete modelObj._isDeleted;
            self.$.createmodeldialog.set('vm', modelObj);
            self.$.createmodeldialog._setFlags(1);
            self.$.createmodeldialog.openDialog();
          });
          self.addEventListener('upload-data', function (e) {
            self.$.modelDataDialog.set('modelObj', e.detail);
            self.$.modelDataDialog.openDialog();
          });
          self.addEventListener('edit-property', function (e) {
            self.$.addProperty.set('propertyObj', {});
            var tempObj = JSON.parse(JSON.stringify(e.detail.property));
            if (tempObj.type == 'array') {
              tempObj.arrayElementType = tempObj.items.type;
            }
            self.$.addProperty.set('modelObj', e.detail.modelObj);
            self.$.addProperty.set('index', e.detail.index);
            self.$.addProperty.set('propertyTypes', self.getPropertyTypes(self.modelList));
            self.$.addProperty.set('propertyObj', tempObj);
            self.$.addProperty.set('editValidation', e.detail.editValidation);
            self.$.addProperty.title = 'Edit Property';
            self.$.addProperty.showProperty = true;
            self.$.addProperty.openDialog();

          });
          self.addEventListener('save-property', function (e) {
            var detail = e.detail;
            var modelNodes = this.$.workarea.querySelectorAll('model-container');
            var modelNode = _.find(modelNodes, function (ele) {
              return (ele.modelObj.id == detail.modelObj.id)
            });
            modelNode.set('modelObj.properties.' + detail.index, detail.propertyObj);
          });

          //do actions needed when elements are disconnected
          self.workAreaInstance.bind('connectionDetached', function (info) {
            if (!self.removeModel) {
              var sourceModel = info.source.modelObj;
              var deleteModelIndex = sourceModel.relations.findIndex(function (
                relation) {
                return relation.model == info.target.modelObj.name
              })
              sourceModel.relations.splice(deleteModelIndex, 1);
            }
            self.relationName = '';
          });
        });
        document.addEventListener('model-selected', function (e) {
          var modelNodes = self.$.workarea.querySelectorAll('model-container');
          [].map.call(modelNodes, function (model) {
            model.classList.remove('active');
          });
          e.target.classList.remove('new');
          e.target.classList.add('active');
        });
        document.addEventListener('model-saved', function (e) {
          self.relationName = '';
          self.newConnection = true;
          self.removeModel = false;
          if (e.detail.newmodel && e.detail.renderInWorkArea) {
            var elem = document.createElement('model-container');
            elem.classList.add('new');
            elem.modelObj = e.detail.model;
            self.push('workSpaceModelList', elem.modelObj);
            self.set('workSpaceModelCount', self.workSpaceModelList.length);
            self.$.workarea.appendChild(elem);
            elem.style.left = Math.round(Math.random() * 100) + 'px';
            elem.style.top = Math.round(Math.random() * 100) + 'px';
            self._setjsPlumbParams(elem);
            self._showExistingRelations();
          } else {
            //update model in the workspacemodels list after editing
            var modelNodes = self.$.workarea.querySelectorAll('model-container');

            [].map.call(modelNodes, function (model) {
              if (model.modelObj.id == e.detail.model.id) {
                model.modelObj = OEUtils.clone(e.detail.model);
              }
            });

            var findIndex = self.workSpaceModelList.findIndex(function (model) {
              return model.id == e.detail.model.id
            })
            self.set('workSpaceModelList.' + findIndex, e.detail.model);

            //reset connections for the model in the workarea
            self._showExistingRelations();
          }
        });
        document.addEventListener('open-options', function (e) {
          //self.set('showButtons', false);
          var model = e.detail.model;
          var type = e.detail.type;
          var obj = {
            model: model,
            type: type,
            name: model.name + '-' + type
          }
          if (self._selectedTab.type === 'view') {
            self._selectedTab.models = self.getWorkSpaceContainers();
          }
          self._openTab(obj);
        });
      }
    });
  </script>
</dom-module>
